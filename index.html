<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anqelba Inclusive Learning Platform</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'anqelba-primary': '#10B981', // Emerald Green
                        'anqelba-secondary': '#F59E0B', // Amber Yellow
                        'anqelba-dark': '#1F2937', // Dark Slate
                        'anqelba-blue': '#3B82F6', // Blue for emotions/Square
                        'anqelba-coral': '#F9A8D4', // Pastel coral/pink / Shapes
                        'anqelba-red': '#EF4444' // Red for Rectangle
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Import Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Style for the main container to account for the fixed header */
        .main-content {
            padding-top: 4rem;
        }
        /* Custom grab cursor for drag-and-drop */
        .draggable-item {
            cursor: grab;
            user-select: none;
        }
        .loader { border-top-color: #10B981; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { to { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-anqelba-dark">
    <!-- Main application container -->
    <div id="app" class="min-h-screen">
        <!-- Content will be injected here by JS -->
    </div>

    <!-- Firebase SDK Imports (Module type required for ES module syntax) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global scope for use in the main script
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
    </script>

    <!-- Main Application Logic -->
    <script>
        // --- GLOBAL CONFIGURATION AND DATA ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // Gemini API Key

        const colors = {
            primary: '#10B981', secondary: '#F59E0B', dark: '#1F2937', blue: '#3B82F6', coral: '#F9A8D4', red: '#EF4444', white: '#FFFFFF'
        };

        const lessons = [
            { id: 'alphabet', title: "Alphabet Match", icon: 'üìñ', colorClass: "bg-anqelba-primary hover:border-anqelba-dark", description: "Match letters to pictures." },
            { id: 'counting', title: "Counting 1-10", icon: 'üî¢', colorClass: "bg-anqelba-secondary hover:border-anqelba-dark", description: "Practice numbers and quantity." },
            { id: 'emotions', title: "Basic Emotions", icon: 'üòÉ', colorClass: "bg-anqelba-blue hover:border-anqelba-dark", description: "Identify feelings and faces." },
            { id: 'shapes', title: "Geometric Shapes", icon: 'üî∫', colorClass: "bg-anqelba-coral hover:border-anqelba-dark", description: "Learn common 2D shapes." },
            // NEW LLM LESSON
            { id: 'storyteller', title: "Story Time ‚ú®", icon: 'ü¶Ñ', colorClass: "bg-purple-500 hover:border-anqelba-dark", description: "Create a new story using AI!" },
        ];

        const alphabets = [
            { letter: 'A', sound: 'a', word: 'Apple', icon: 'üçé' },
            { letter: 'B', sound: 'b', word: 'Ball', icon: '‚öΩ' },
            { letter: 'C', sound: 'c', word: 'Cat', icon: 'üêà' },
            { letter: 'D', sound: 'd', word: 'Dog', icon: 'üêï' },
        ];

        const emotionsData = [
            { id: 'happy', label: 'Happy', icon: 'üòä', scenario: 'You got a new toy!' },
            { id: 'sad', label: 'Sad', icon: 'üò¢', scenario: 'It is raining outside and you can‚Äôt play.' },
            { id: 'angry', label: 'Angry', icon: 'üò°', scenario: 'Someone took your block.' },
            { id: 'surprised', label: 'Surprised', icon: 'üòÆ', scenario: 'You open the door and all your friends yell "Surprise!"' },
        ];
        
        const teacherTopics = [
            { id: 'emotions', label: 'Basic Emotions' },
            { id: 'shapes', label: 'Geometric Shapes' },
            { id: 'alphabet', label: 'The Alphabet' },
            { id: 'counting', label: 'Numbers and Counting' },
        ];

        const countingItems = ['üçé', 'üçå', '‚≠ê', '‚öΩ', 'üöó', 'üß∏', 'ü¶Ü', 'ü¶ã', 'üéà', 'üßÅ'];
        
        const shapesData = [
            { id: 'square', label: 'Square', definition: 'A shape with four equal sides and four square corners.', color: colors.blue },
            { id: 'circle', label: 'Circle', definition: 'A perfectly round shape.', color: colors.primary },
            { id: 'triangle', label: 'Triangle', definition: 'A shape with three straight sides and three corners.', color: colors.secondary },
            { id: 'rectangle', label: 'Rectangle', definition: 'A shape with four sides where opposite sides are equal, and four square corners.', color: colors.red },
        ];


        // --- STATE MANAGEMENT ---
        const state = {
            view: 'roleSelection', // 'roleSelection', 'studentDashboard', 'alphabetMatch', 'emotionsMatch', 'countingGame', 'shapesMatch', 'teacherDashboard', 'storyGeneratorView'
            currentRole: null,
            userId: null,
            progress: {},
            message: null,
            messageType: 'info',
            contrast: false,
            fontSizeLevel: 1, // 1 (normal) or 2 (large)
            currentGame: { score: 0, target: null, options: [], dropped: [] },
            // NEW LLM STATES
            story: { title: null, content: null, loading: false, topic: '' },
            assessment: { questions: [], loading: false, topic: 'emotions' }
        };

        const setState = (newState) => {
            Object.assign(state, newState);
            render();
        };

        // --- FIREBASE GLOBALS ---
        let app, db, auth;

        // --- UTILITY FUNCTIONS ---

        /** Generates a simple SVG icon string (adapted from Lucide for single-file HTML) */
        const createIcon = (name, size = 20, classes = '') => {
            const svgMap = {
                Home: `<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>`,
                Palette: `<path d="M12.22 17.5l-6.8-6.8a1 1 0 0 1 0-1.4l1.4-1.4a1 1 0 0 1 1.4 0l6.8 6.8"/><circle cx="12" cy="12" r="10"/><path d="M19 15l-1.5-1.5M15 19l-1.5-1.5"/>`,
                User: `<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>`,
                BookOpen: `<path d="M2 19.5c0 .3.2.5.5.5H19c.3 0 .5-.2.5-.5v-15c0-.3-.2-.5-.5-.5H2.5c-.3 0-.5.2-.5.5z"/><path d="M10 16L12 14 14 16"/><path d="M12 21.5V14"/>`,
                Smile: `<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/>`,
                SquareEqual: `<rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 10h10"/><path d="M7 14h10"/>`,
                Lightbulb: `<path d="M15 14c.2-1 .5-2 1.3-2.7C17.5 10 18 9 18 8.5 18 6.5 14.5 4 12 4s-6 2.5-6 4.5c0 .5.5 1.5 1.7 2.8s1.5 1.7 1.3 2.7"/><line x1="12" x2="12" y1="18" y2="20"/><line x1="8" x2="8" y1="21" y2="22"/><line x1="16" x2="16" y1="21" y2="22"/>`,
                CheckCircle: `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/>`,
                Volume2: `<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M17.08 6a8.49 8.49 0 0 1 0 12"/><path d="M19.07 3a10.49 10.49 0 0 1 0 18"/>`,
                ArrowLeft: `<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>`,
                ShoppingBasket: `<path d="m15 11-1 9"/><path d="m19 11-1 9"/><path d="m6 11 1 9"/><path d="m3 7 13.71 1.96 1.13 4.29-10.3 1.94-1.12-4.28z"/><path d="M12 10V3"/><path d="M7 10V3"/><path d="M17 10V3"/><path d="M22 7.72L20 6H4L2 7.72"/>`
            };
            const path = svgMap[name] || '';
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><g>${path}</g></svg>`;
        };

        /** Generates a simple SVG shape. */
        const getShapeSVG = (shapeId, size = 100, color = 'currentColor') => {
            let path = '';
            const half = size / 2;
            const center = size / 2;

            switch (shapeId) {
                case 'square':
                    path = `<rect x="10" y="10" width="${size - 20}" height="${size - 20}" rx="10" fill="${color}" stroke-width="4" stroke="white"/>`;
                    break;
                case 'circle':
                    path = `<circle cx="${center}" cy="${center}" r="${half - 10}" fill="${color}" stroke-width="4" stroke="white"/>`;
                    break;
                case 'triangle':
                    // Points for an equilateral triangle pointing up
                    path = `<polygon points="${center},10 10,${size - 10} ${size - 10},${size - 10}" fill="${color}" stroke-width="4" stroke="white"/>`;
                    break;
                case 'rectangle':
                    // Tall rectangle
                    path = `<rect x="15" y="10" width="${size - 30}" height="${size - 20}" rx="10" fill="${color}" stroke-width="4" stroke="white"/>`;
                    break;
                default:
                    path = '';
            }
            return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">${path}</svg>`;
        };


        // --- TTS UTILITIES (for speaking stories and instructions) ---

        /** Converts Base64 string to ArrayBuffer. */
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        /** Helper to write string to DataView. */
        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        /** Creates a WAV Blob from 16-bit signed PCM data. */
        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);

            // RIFF identifier 'RIFF'
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.byteLength, true); // file length
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt '); // format chunk identifier 'fmt '
            view.setUint32(16, 16, true); // format chunk length
            view.setUint16(20, 1, true); // sample format (1 for PCM)
            view.setUint16(22, 1, true); // number of channels
            view.setUint32(24, sampleRate, true); // sample rate
            view.setUint32(28, sampleRate * 2, true); // byte rate (SampleRate * Channels * BitsPerSample / 8)
            view.setUint16(32, 2, true); // block align (Channels * BitsPerSample / 8)
            view.setUint16(34, 16, true); // bits per sample
            writeString(view, 36, 'data'); // data chunk identifier 'data'
            view.setUint32(40, pcmData.byteLength, true); // data chunk length

            // Write PCM data
            const pcmView = new Int16Array(buffer, 44);
            for (let i = 0; i < pcmData.length; i++) {
                pcmView[i] = pcmData[i];
            }

            return new Blob([view.buffer], { type: 'audio/wav' });
        };

        let currentAudio = null; // Global to manage single playback instance

        /** TTS Function using Gemini API. */
        const speak = async (text, voice = "Kore") => {
            if (!text || !db) return;

            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voice }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) break;

                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    if (i === 2) throw new Error('API failed after multiple retries.');
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);

                    const audioUrl = URL.createObjectURL(wavBlob);
                    currentAudio = new Audio(audioUrl);

                    currentAudio.play().catch(e => {
                        if (e.name !== 'AbortError') {
                            console.error("Audio Playback Error:", e);
                        }
                    });
                } else {
                    throw new Error("Invalid audio response structure or data.");
                }
            } catch (error) {
                console.error("TTS Error:", error);
            }
        };

        const roleSpeak = (text) => {
            if (state.currentRole === 'student') {
                speak(text);
            }
        };

        // --- LLM API UTILITY (for text generation) ---
        
        /** Generalized function to call the Gemini generateContent API with exponential backoff. */
        const callGeminiApi = async (userQuery, systemPrompt, generationConfig = null) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
            };

            if (systemPrompt) {
                payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            }

            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }

            let response;
            let delay = 500;
            const maxRetries = 3;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (generationConfig && generationConfig.responseMimeType === "application/json") {
                            // For structured JSON, the text part is the JSON string
                            return JSON.parse(text);
                        }
                        return text;
                    }

                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`, error);
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }

            throw new Error('Gemini API request failed after all retries.');
        };


        // --- FIREBASE LOGIC ---

        const initializeFirebase = async () => {
            if (typeof window.initializeApp === 'undefined') {
                console.error("Firebase SDK not loaded.");
                return;
            }

            try {
                app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);
                console.log("Firebase initialized.");

                // Sign in logic
                if (initialAuthToken) {
                    await window.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await window.signInAnonymously(auth);
                }

                // Auth state listener
                window.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setState({ userId: user.uid });
                        setupProgressListener(user.uid);
                    } else {
                        setState({ userId: null });
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                handleMessage("Authentication failed. Data saving disabled.", 'error');
            }
        };

        const setupProgressListener = (userId) => {
            if (!db || !userId) return;

            const progressRef = window.doc(db, `artifacts/${appId}/users/${userId}/progress`, 'lessons');

            window.onSnapshot(progressRef, (docSnap) => {
                const newProgress = docSnap.exists() ? (docSnap.data() || {}) : {};
                setState({ progress: newProgress });
            }, (error) => {
                console.error("Firestore Progress Snapshot Error:", error);
            });
        };

        const updateProgress = async (lessonId, newScore) => {
            const currentUserId = state.userId;
            if (!db || !currentUserId) {
                handleMessage("Cannot save progress. User not authenticated or Firestore unavailable.", 'error');
                return;
            }

            const progressRef = window.doc(db, `artifacts/${appId}/users/${currentUserId}/progress`, 'lessons');

            try {
                await window.setDoc(progressRef, { [lessonId]: newScore }, { merge: true });
                console.log(`Progress for ${lessonId} updated.`);
            } catch (error) {
                console.error("Error updating progress:", error);
                handleMessage("Failed to save progress.", 'error');
            }
        };

        // --- UI UTILITIES ---

        const handleMessage = (msg, type = 'info') => {
            setState({ message: msg, messageType: type });
            setTimeout(() => setState({ message: null }), 3000);
        };

        const renderMessageBox = () => {
            const { message, messageType } = state;
            if (!message) return '';

            let bgColor, textColor, borderColor;
            switch (messageType) {
                case 'success': bgColor = 'bg-green-100'; borderColor = 'border-green-500'; textColor = 'text-green-700'; break;
                case 'error': bgColor = 'bg-red-100'; borderColor = 'border-red-500'; textColor = 'text-red-700'; break;
                case 'info': bgColor = 'bg-blue-100'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; break;
                case 'primary':
                default: bgColor = 'bg-anqelba-primary/20'; borderColor = 'border-anqelba-primary'; textColor = 'text-anqelba-dark';
            }

            return `
                <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 rounded-xl shadow-2xl border-l-4 ${bgColor} ${borderColor} ${textColor} z-50 transition-opacity duration-300 max-w-sm md:max-w-md">
                    <p class="font-semibold">${message}</p>
                </div>
            `;
        };

        // --- VIEW RENDERERS (Core App Layout) ---

        const renderHeader = () => {
            const isDashboard = state.view.includes('Dashboard');
            const contrastClass = state.contrast ? 'bg-anqelba-dark/90' : 'bg-anqelba-primary';
            const fontSizeClass = state.fontSizeLevel === 2 ? 'text-lg md:text-xl' : 'text-base md:text-lg';

            return `
                <header class="fixed top-0 left-0 right-0 z-40 ${contrastClass} shadow-lg p-3 flex justify-between items-center ${fontSizeClass}">
                    <div class="flex items-center space-x-2">
                        ${createIcon('Palette', 28, 'text-white')}
                        <h1 class="text-xl md:text-2xl font-black text-white">Anqelba</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="toggleContrast" title="Toggle High Contrast" class="p-2 rounded-full bg-white/20 hover:bg-white/40 text-white transition">
                            ${createIcon('Lightbulb', 20)}
                        </button>
                        <button id="toggleFontSize" title="Toggle Font Size" class="p-2 rounded-full bg-white/20 hover:bg-white/40 text-white transition">
                            <span class="font-bold">${state.fontSizeLevel === 1 ? 'A+' : 'A++'}</span>
                        </button>
                        ${isDashboard || state.view.includes('Match') || state.view.includes('Game') || state.view.includes('storyGeneratorView') ? `
                            <button id="goHome" title="Go Home / Change Role" class="p-2 rounded-full bg-white/20 hover:bg-white/40 text-white transition">
                                ${createIcon('Home', 20)}
                            </button>
                        ` : ''}
                    </div>
                </header>
            `;
        };

        const renderRoleSelection = () => {
            return `
                <div class="flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] p-6">
                    <h2 class="text-4xl font-extrabold text-anqelba-dark mb-12 text-center">I am a...</h2>
                    <div class="flex flex-col md:flex-row gap-8">
                        <div id="select-student" class="flex flex-col items-center p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-shadow cursor-pointer bg-anqelba-primary/90 text-white w-full md:w-60">
                            ${createIcon('User', 64, 'mx-auto')}
                            <h3 class="text-3xl font-bold mt-4">Student</h3>
                            <p class="text-sm mt-2 text-center opacity-80">Interactive lessons</p>
                        </div>
                        <div id="select-teacher" class="flex flex-col items-center p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-shadow cursor-pointer bg-anqelba-dark/90 text-white w-full md:w-60">
                            ${createIcon('BookOpen', 64, 'mx-auto')}
                            <h3 class="text-3xl font-bold mt-4">Teacher/Admin</h3>
                            <p class="text-sm mt-2 text-center opacity-80">Progress tracking & settings</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderStudentDashboard = () => {
            const totalStars = Object.values(state.progress).reduce((acc, curr) => acc + curr, 0);

            const lessonCards = lessons.map(lesson => `
                <div data-lesson-id="${lesson.id}" class="lesson-card p-6 rounded-3xl shadow-lg cursor-pointer transition-all duration-300 border-b-8 ${lesson.colorClass}">
                    <div class="flex justify-between items-start text-white">
                        <span class="text-4xl">${lesson.icon}</span>
                        <div class="text-right">
                            <span class="text-2xl font-bold">
                                ${state.progress[lesson.id] || 0} / 5 ‚≠ê
                            </span>
                        </div>
                    </div>
                    <h3 class="text-2xl font-extrabold mt-4 text-white">${lesson.title}</h3>
                    <p class="text-sm mt-1 text-white opacity-80">${lesson.description}</p>
                    ${(state.progress[lesson.id] || 0) >= 5 ? `<div class="mt-2 text-yellow-300">${createIcon('CheckCircle', 24, 'inline-block')}</div>` : ''}
                </div>
            `).join('');

            return `
                <div class="main-content p-4 md:p-8">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-black text-anqelba-dark">Let's Learn and Play!</h2>
                        <button data-speak="Welcome back! Choose a lesson to start." class="tts-button text-anqelba-primary hover:scale-110 transition">
                            ${createIcon('Volume2', 32, 'cursor-pointer')}
                        </button>
                    </div>

                    <div class="bg-anqelba-blue/20 p-4 rounded-xl mb-8 shadow-inner">
                        <p class="text-sm font-semibold text-anqelba-dark mb-2">Your ID: <span class="font-mono text-xs">${state.userId || 'Loading...'}</span></p>
                        <p class="text-lg font-bold text-anqelba-dark">Total Stars: <span class="text-anqelba-secondary">${totalStars}</span> ‚≠ê</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${lessonCards}
                    </div>
                </div>
            `;
        };
        
        // --- Teacher Dashboard and LLM Assessment Feature ---
        
        const generateAssessment = async () => {
            const topic = document.getElementById('assessmentTopic').value;
            setState({ assessment: { ...state.assessment, loading: true, questions: [] } });

            const systemPrompt = `You are an educational assistant. Generate 3 multiple-choice questions for a student learning about ${topic}. Each question must have exactly 4 options (A, B, C, D) and specify the correct answer key (A, B, C, or D). Use simple language suitable for early learners.`;
            const userQuery = `Generate 3 simple multiple-choice questions about the topic: ${topic}.`;

            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    description: "A list of multiple choice questions.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING" },
                            "options": {
                                "type": "OBJECT",
                                "properties": {
                                    "A": { "type": "STRING" },
                                    "B": { "type": "STRING" },
                                    "C": { "type": "STRING" },
                                    "D": { "type": "STRING" }
                                },
                                "required": ["A", "B", "C", "D"]
                            },
                            "answerKey": { "type": "STRING", "description": "The key of the correct option (A, B, C, or D)." }
                        },
                        "required": ["question", "options", "answerKey"]
                    }
                }
            };

            try {
                handleMessage("Generating assessment questions...", 'info');
                const generatedQuestions = await callGeminiApi(userQuery, systemPrompt, generationConfig);

                setState({
                    assessment: {
                        questions: generatedQuestions,
                        loading: false,
                        topic: topic
                    }
                });
                handleMessage(`3 questions on ${topic} generated for review.`, 'success');

            } catch (e) {
                console.error(e);
                handleMessage("Failed to generate assessment questions.", 'error');
                setState({ assessment: { ...state.assessment, loading: false } });
            }
        };


        const renderTeacherDashboard = () => {
            const { questions, loading, topic } = state.assessment;

            const topicsOptions = teacherTopics.map(t => `<option value="${t.id}" ${topic === t.id ? 'selected' : ''}>${t.label}</option>`).join('');
            
            const questionsHTML = questions.map((q, qIndex) => `
                <div class="mb-6 p-4 border rounded-xl bg-gray-50 shadow-sm">
                    <p class="font-bold mb-2">Q${qIndex + 1}: ${q.question}</p>
                    <div class="space-y-1">
                        ${Object.keys(q.options).map(key => `
                            <p class="${key === q.answerKey ? 'bg-green-100 font-semibold' : 'hover:bg-gray-100'} p-2 rounded text-sm flex justify-between items-center">
                                <span>${key}) ${q.options[key]}</span>
                                ${key === q.answerKey ? `<span class="text-green-600">${createIcon('CheckCircle', 16)} Correct</span>` : ''}
                            </p>
                        `).join('')}
                    </div>
                </div>
            `).join('');


            return `
                <div class="main-content p-4 md:p-8">
                    <h2 class="text-3xl font-black text-anqelba-dark mb-8">Teacher/Admin Dashboard</h2>
                    
                    <div class="mb-10 p-6 rounded-xl shadow-lg border-l-4 border-anqelba-dark bg-white">
                        <p class="text-xl font-bold mb-4">Administration Tools</p>
                        <button id="teacherChangeRole" class="px-4 py-2 bg-anqelba-dark text-white rounded-full hover:bg-gray-700 transition">
                            Change Role
                        </button>
                    </div>

                    <!-- Gemini LLM Assessment Generator -->
                    <div class="p-6 rounded-xl shadow-lg border-l-4 border-anqelba-primary bg-anqelba-primary/10">
                        <h3 class="text-2xl font-bold text-anqelba-dark mb-4 flex items-center">
                            Assessment Creator ‚ú®
                        </h3>
                        <p class="text-gray-700 mb-4">Generate 3 multiple-choice questions for any of the core lessons below.</p>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <select id="assessmentTopic" class="flex-grow p-3 rounded-lg border border-gray-300 shadow-inner bg-white text-anqelba-dark">
                                ${topicsOptions}
                            </select>
                            <button id="generateAssessmentBtn" ${loading ? 'disabled' : ''} class="px-6 py-3 bg-anqelba-primary text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                ${loading ? `<div class="loader ease-linear rounded-full border-4 border-t-4 border-white h-5 w-5 mr-2"></div> Generating...` : 'Generate Questions'}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Generated Questions Display -->
                    <div class="mt-8">
                        <h4 class="text-xl font-bold text-anqelba-dark mb-4">Review Assessment:</h4>
                        ${questions.length > 0 ? questionsHTML : `<p class="text-gray-500">No questions generated yet. Use the creator above!</p>`}
                    </div>
                </div>
            `;
        };

        // --- LLM Story Generator Feature ---
        
        const generateStory = async () => {
            const topicInput = document.getElementById('storyTopic');
            const topic = topicInput.value.trim();
            if (!topic) {
                handleMessage("Please enter a topic for the story.", 'error');
                return;
            }

            setState({ story: { ...state.story, loading: true, content: null, title: null } });

            const systemPrompt = "You are a friendly children's book author writing for a 5-year-old. Your language must be simple, positive, and use short sentences. The story should be about 5-6 short paragraphs long. Include a simple title.";
            const userQuery = `Write a short story about the following topic: ${topic}.`;

            try {
                handleMessage("Generating your story...", 'info');
                const generatedText = await callGeminiApi(userQuery, systemPrompt);

                // Simple parsing: first line is title, rest is content
                const lines = generatedText.split('\n').filter(line => line.trim() !== '');
                
                // Try to find the title (first bolded/capitalized line)
                let title = lines[0] || `The Story of ${topic}`;
                let content = lines.slice(1).join('\n\n');
                
                // If the first line is clearly a title, use it. Otherwise, assume the first few lines are intro/title.
                if(lines.length > 1 && lines[0].length < 50 && (lines[0].toUpperCase() === lines[0] || lines[0].includes('Title'))){
                   title = lines[0];
                   content = lines.slice(1).join('\n\n');
                } else {
                   // If structure is poor, just use the first paragraph as intro
                   title = `The Story of ${topic}`;
                   content = generatedText;
                }

                setState({
                    story: {
                        title: title,
                        content: content.trim(),
                        loading: false,
                        topic: topic
                    }
                });
                handleMessage("Story generated! Press the speaker icon to hear it.", 'success');
                roleSpeak(`A new story, ${title}, is ready!`);

            } catch (e) {
                console.error(e);
                handleMessage("Sorry, I couldn't generate the story right now. Try again!", 'error');
                setState({ story: { ...state.story, loading: false } });
            }
        };
        
        const renderStoryGenerator = () => {
            const { title, content, loading, topic } = state.story;

            const displayContent = content ? content.split('\n\n').map(p => `<p class="mb-4">${p}</p>`).join('') : '';

            return `
                <div class="main-content p-4 md:p-8 bg-white rounded-3xl">
                    <h3 class="text-3xl font-black text-center text-anqelba-dark mb-4 flex items-center justify-center">
                        Story Time Generator ‚ú®
                    </h3>

                    <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-lg font-bold">Imagination: <span class="text-anqelba-secondary">${topic || 'None'}</span></p>
                        <button id="backToDashboard" class="text-anqelba-dark font-semibold hover:text-anqelba-primary transition duration-200">
                            ${createIcon('ArrowLeft', 20, 'inline mr-2')} Back
                        </button>
                    </div>

                    <!-- Input Card -->
                    <div class="p-6 rounded-2xl mb-8 shadow-lg bg-purple-100 border-b-4 border-purple-500">
                        <p class="text-xl font-bold mb-2 text-anqelba-dark">What kind of story do you want?</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="storyTopic" placeholder="e.g., A friendly robot, a flying dog, a trip to the moon" class="flex-grow p-3 rounded-lg border border-gray-300 shadow-inner text-anqelba-dark">
                            <button id="generateStoryBtn" ${loading ? 'disabled' : ''} class="px-6 py-3 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                ${loading ? `<div class="loader ease-linear rounded-full border-4 border-t-4 border-white h-5 w-5 mr-2"></div> Writing...` : 'Write Story'}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Story Display -->
                    <div class="p-6 rounded-2xl shadow-xl bg-white border border-gray-200 min-h-[250px]">
                        ${loading ? `
                            <div class="flex flex-col items-center justify-center h-40">
                                <div class="loader ease-linear rounded-full border-8 border-t-8 border-purple-500 h-16 w-16"></div>
                                <p class="mt-4 text-purple-600 font-semibold">The writer is busy...</p>
                            </div>
                        ` : (content ? `
                            <h4 class="text-3xl font-extrabold text-anqelba-dark mb-4 text-center">${title}</h4>
                            <div class="text-anqelba-dark leading-relaxed">
                                ${displayContent}
                            </div>
                            <div class="text-center mt-6">
                                <button data-speak="${title}. ${content.replace(/\n\n/g, ' ')}" class="tts-button text-purple-600 hover:scale-110 transition p-3 rounded-full bg-purple-200 shadow-md">
                                    ${createIcon('Volume2', 36, 'cursor-pointer')}
                                    <span class="ml-2 font-semibold">Read Story Aloud</span>
                                </button>
                            </div>
                        ` : `
                            <p class="text-center text-gray-500 py-10">Your custom story will appear here!</p>
                        `)}
                    </div>
                </div>
            `;
        };
        
        // --- GAME RENDERERS AND LOGIC (Omitted for brevity, assumed unchanged) ---
        // ... (AlphabetMatch, EmotionsMatch, CountingGame, ShapesMatch logic is unchanged)
        
        const initializeAlphabetMatch = () => {
            const target = alphabets[Math.floor(Math.random() * alphabets.length)];
            const otherLetters = alphabets.filter(a => a.letter !== target.letter).map(a => a.letter);
            const shuffledOptions = [target.letter, ...otherLetters].slice(0, 3).sort(() => Math.random() - 0.5);

            setState({
                currentGame: {
                    score: state.currentGame.score,
                    target: target,
                    options: shuffledOptions
                }
            });
            roleSpeak(`Find the letter ${target.letter}.`);
        };

        const checkAlphabetAnswer = (selectedLetter) => {
            const { target, score } = state.currentGame;
            if (selectedLetter === target.letter) {
                const newScore = score + 1;
                if (newScore >= 5) {
                    handleMessage('Lesson Complete! You earned 5 stars! üéâ', 'success');
                    updateProgress('alphabet', 5);
                    roleSpeak(`Yes! ${target.letter} is for ${target.word}. Amazing! Lesson complete! You earned five stars!`);
                    setTimeout(() => setState({ view: 'studentDashboard', currentGame: { score: 0 } }), 4000);
                } else {
                    handleMessage(`That's correct! ${target.letter} for ${target.word}! ‚≠ê`, 'primary');
                    roleSpeak(`Yes! ${target.letter} is for ${target.word}. That's correct!`);
                    setState({ currentGame: { ...state.currentGame, score: newScore } });
                    setTimeout(initializeAlphabetMatch, 2000);
                }
            } else {
                handleMessage('Oops! Try finding the correct letter again.', 'error');
                roleSpeak(`Not quite. Try finding the letter ${target.letter} again.`);
            }
        };

        const renderAlphabetMatch = () => {
            const { target, options, score } = state.currentGame;
            if (!target) return '';

            const optionsHTML = options.map((letter, index) => `
                <button data-letter="${letter}" class="check-alphabet-btn p-6 md:p-10 rounded-2xl shadow-xl transition-transform transform hover:scale-[1.05] border-b-4 border-anqelba-dark/50 ${letter === target.letter ? 'bg-anqelba-secondary' : 'bg-anqelba-coral'}">
                    <span class="text-5xl md:text-7xl font-black text-white">${letter}</span>
                </button>
            `).join('');

            return `
                <div class="main-content p-4 md:p-8 bg-white rounded-3xl">
                    <h3 class="text-3xl font-black text-center text-anqelba-dark mb-4">Alphabet Match</h3>

                    <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-lg font-bold">Score: <span class="text-anqelba-secondary">${score} / 5</span></p>
                        <button id="backToDashboard" class="text-anqelba-dark font-semibold hover:text-anqelba-primary transition duration-200">
                            ${createIcon('ArrowLeft', 20, 'inline mr-2')} Back
                        </button>
                    </div>

                    <div class="p-8 rounded-2xl mb-8 text-center shadow-lg bg-anqelba-primary text-white">
                        <p class="text-xl font-bold mb-2">Which letter matches this word?</p>
                        <div class="flex justify-center items-center">
                            <button data-speak="Find the letter for ${target.word}." class="tts-button mr-4 cursor-pointer hover:scale-110 transition text-yellow-300">
                                ${createIcon('Volume2', 32)}
                            </button>
                            <p class="text-5xl font-extrabold">${target.icon}</p>
                            <p class="text-5xl font-extrabold ml-4">${target.word}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        };

        // --- Emotions Game Logic (Unchanged) ---
        const initializeEmotionsMatch = () => {
            const target = emotionsData[Math.floor(Math.random() * emotionsData.length)];
            const otherEmotions = emotionsData.filter(e => e.id !== target.id).sort(() => Math.random() - 0.5);
            const shuffledOptions = [target, ...otherEmotions].slice(0, 4).sort(() => Math.random() - 0.5);

            setState({
                currentGame: {
                    score: state.currentGame.score,
                    target: target,
                    options: shuffledOptions
                }
            });
            roleSpeak(`Which face is ${target.label}?`);
        };

        const checkEmotionsAnswer = (selectedId) => {
            const { target, score } = state.currentGame;
            if (selectedId === target.id) {
                const newScore = score + 1;
                if (newScore >= 5) {
                    handleMessage('Lesson Complete! You earned 5 stars! üéâ', 'success');
                    updateProgress('emotions', 5);
                    roleSpeak(`Fantastic! That is the ${target.label} face. Amazing! Lesson complete! You earned five stars!`);
                    setTimeout(() => setState({ view: 'studentDashboard', currentGame: { score: 0 } }), 4000);
                } else {
                    handleMessage(`Fantastic! That is the ${target.label} face! ‚≠ê`, 'primary');
                    roleSpeak(`Fantastic! That is the ${target.label} face.`);
                    setState({ currentGame: { ...state.currentGame, score: newScore } });
                    setTimeout(initializeEmotionsMatch, 2000);
                }
            } else {
                const selectedEmotion = emotionsData.find(e => e.id === selectedId);
                handleMessage(`Oops! That's the ${selectedEmotion.label} face. Try again!`, 'error');
                roleSpeak(`Oops! The ${selectedEmotion.label} face is when you feel ${selectedEmotion.scenario}. Try again.`);
            }
        };

        const renderEmotionsMatch = () => {
            const { target, options, score } = state.currentGame;
            if (!target) return '';

            const optionsHTML = options.map((emotion) => `
                <button data-emotion-id="${emotion.id}" class="check-emotions-btn flex flex-col items-center p-4 md:p-6 rounded-2xl shadow-xl transition-transform transform hover:scale-[1.05] border-b-4 border-anqelba-dark/50 bg-white">
                    <span class="text-6xl md:text-8xl">${emotion.icon}</span>
                    <span class="text-lg md:text-xl font-bold text-anqelba-dark mt-2">${emotion.label}</span>
                </button>
            `).join('');

            return `
                <div class="main-content p-4 md:p-8 bg-white rounded-3xl">
                    <h3 class="text-3xl font-black text-center text-anqelba-dark mb-4">Basic Emotions Game</h3>

                    <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-lg font-bold">Score: <span class="text-anqelba-secondary">${score} / 5</span></p>
                        <button id="backToDashboard" class="text-anqelba-dark font-semibold hover:text-anqelba-primary transition duration-200">
                            ${createIcon('ArrowLeft', 20, 'inline mr-2')} Back
                        </button>
                    </div>

                    <div class="p-8 rounded-2xl mb-8 text-center shadow-lg bg-anqelba-blue text-white">
                        <p class="text-xl font-bold mb-2">Which face shows:</p>
                        <div class="flex justify-center items-center">
                            <button data-speak="Which face shows ${target.label}?" class="tts-button mr-4 cursor-pointer hover:scale-110 transition text-yellow-300">
                                ${createIcon('Volume2', 32)}
                            </button>
                            <p class="text-5xl font-extrabold">${target.label}</p>
                        </div>
                        <p class="text-lg mt-2 opacity-80">${target.scenario}</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        };

        // --- Counting Game Logic (Unchanged) ---
        const initializeCountingGame = (level = 1) => {
            const newTarget = Math.floor(Math.random() * (level > 2 ? 10 : 5)) + 1; // 1-5 for level 1-2, up to 10 after
            const newItemIcon = countingItems[Math.floor(Math.random() * countingItems.length)];

            setState({
                currentGame: {
                    score: state.currentGame.score,
                    target: { number: newTarget, icon: newItemIcon },
                    dropped: [],
                    level: level
                }
            });
            roleSpeak(`Level ${level}. Let's count ${newTarget} ${newItemIcon}. Drag ${newTarget} items to the basket.`);
        };

        const checkCountingAnswer = () => {
            const { target, dropped, score, level } = state.currentGame;
            if (dropped.length === target.number) {
                // Success
                const newScore = score + 1;
                handleMessage('Great Job! One star earned! ‚≠ê', 'primary');
                roleSpeak(`Yes! That is ${target.number}! One star earned. Let's try the next one.`);

                if (newScore >= 5) {
                    handleMessage('Lesson Complete! You earned 5 stars! üéâ', 'success');
                    updateProgress('counting', 5);
                    setTimeout(() => setState({ view: 'studentDashboard', currentGame: { score: 0 } }), 4000);
                } else {
                    setState({ currentGame: { ...state.currentGame, score: newScore } });
                    setTimeout(() => initializeCountingGame(level + 1), 2000);
                }
            } else {
                // Failure
                handleMessage(`Oops! That's ${dropped.length}. We need ${target.number}. Try again!`, 'error');
                roleSpeak(`Oops! You put ${dropped.length} in the basket. We need ${target.number}. Let's try again.`);
                setState({ currentGame: { ...state.currentGame, dropped: [] } }); // Reset the basket
            }
        };

        const resetBasket = () => {
            setState({ currentGame: { ...state.currentGame, dropped: [] } });
            roleSpeak("Basket is empty. Let's start counting again.");
        };

        const handleDrop = (e) => {
            e.preventDefault();
            const draggedItem = e.dataTransfer.getData("item");
            const { icon } = state.currentGame.target;
            if (draggedItem === icon) {
                setState({ currentGame: { ...state.currentGame, dropped: [...state.currentGame.dropped, draggedItem] } });
            }
        };

        const renderCountingGame = () => {
            const { target, dropped, score, level } = state.currentGame;
            if (!target) return '';

            const targetClass = 'border-dashed border-4 border-anqelba-blue bg-anqelba-blue/20';
            const itemIcon = target.icon;

            const droppedItemsHTML = dropped.map((item, index) => `<span class="text-4xl">${item}</span>`).join('');

            return `
                <div class="main-content p-4 md:p-8 bg-white rounded-3xl">
                    <h3 class="text-3xl font-black text-center text-anqelba-dark mb-4">Counting ${target.number}</h3>

                    <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-lg font-bold">Score: <span class="text-anqelba-secondary">${score} / 5</span></p>
                        <p class="text-lg font-bold">Level: <span class="text-anqelba-primary">${level}</span></p>
                    </div>

                    <div class="p-8 rounded-2xl mb-8 text-center shadow-lg bg-anqelba-secondary text-anqelba-dark">
                        <p class="text-xl font-bold mb-2">Count this many items:</p>
                        <div class="flex justify-center items-center">
                            <button data-speak="Count ${target.number} ${itemIcon}." class="tts-button mr-4 cursor-pointer hover:scale-110 transition">
                                ${createIcon('Volume2', 32)}
                            </button>
                            <p class="text-7xl font-extrabold">${target.number}</p>
                            <span class="text-7xl font-extrabold ml-4">${itemIcon}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <!-- Draggable Item Source -->
                        <div class="flex flex-col items-center p-4 bg-white rounded-xl shadow-md">
                             <p class="text-lg font-bold mb-4 text-anqelba-dark">Drag items from here...</p>
                            <div
                                draggable="true"
                                data-item="${itemIcon}"
                                id="draggableSource"
                                class="draggable-item p-6 rounded-xl shadow-lg cursor-grab text-center transform transition-transform hover:scale-[1.05] bg-anqelba-coral"
                            >
                                <span class="text-7xl">${itemIcon}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">(Tap and hold or drag this item)</p>
                        </div>

                        <!-- Target Area (Drop Zone) -->
                        <div
                            id="dropZone"
                            class="p-6 rounded-2xl transition-all duration-300 shadow-inner min-h-[200px] ${targetClass}"
                            ondragover="event.preventDefault();"
                            ondrop="handleDrop(event);"
                        >
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-lg font-bold text-anqelba-dark">...into the basket!</p>
                                ${createIcon('ShoppingBasket', 32, 'text-anqelba-dark')}
                            </div>

                            <div class="flex flex-wrap gap-2 p-2 bg-white rounded-lg min-h-[100px] items-center">
                                ${droppedItemsHTML}
                            </div>
                            <p class="text-center text-anqelba-dark font-bold text-2xl mt-4">Total: ${dropped.length}</p>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
                        <button id="resetBasket" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-full shadow-md hover:bg-red-600 transition duration-200">
                            Empty Basket
                        </button>
                        <button id="checkCountingAnswer" class="px-8 py-4 bg-green-500 text-white font-extrabold text-lg rounded-full shadow-lg hover:bg-green-600 transition duration-200 transform hover:scale-[1.02]">
                            Check My Answer!
                        </button>
                    </div>

                    <div class="mt-8 text-center">
                         <button id="backToDashboard" class="px-6 py-3 bg-gray-300 text-anqelba-dark font-semibold rounded-full shadow-md hover:bg-gray-400 transition duration-200">
                            ${createIcon('ArrowLeft', 20, 'inline mr-2')} Back to Lessons
                        </button>
                    </div>
                </div>
            `;
        };
        // --- Shapes Match Game Logic (Unchanged) ---
        const initializeShapesMatch = () => {
            const target = shapesData[Math.floor(Math.random() * shapesData.length)];
            // Select 3 other random options, making sure the target is included
            const optionsPool = shapesData.filter(s => s.id !== target.id);
            const shuffledOptions = [target, ...optionsPool.sort(() => Math.random() - 0.5).slice(0, 3)].sort(() => Math.random() - 0.5);

            setState({
                currentGame: {
                    score: state.currentGame.score,
                    target: target,
                    options: shuffledOptions
                }
            });
            roleSpeak(`What shape is a ${target.label}?`);
        };

        const checkShapesAnswer = (selectedId) => {
            const { target, score } = state.currentGame;
            if (selectedId === target.id) {
                const newScore = score + 1;
                if (newScore >= 5) {
                    handleMessage('Lesson Complete! You earned 5 stars! üéâ', 'success');
                    updateProgress('shapes', 5);
                    roleSpeak(`You got it! This is a ${target.label}! Lesson complete! You earned five stars!`);
                    setTimeout(() => setState({ view: 'studentDashboard', currentGame: { score: 0 } }), 4000);
                } else {
                    handleMessage(`That's right! It's a ${target.label}! ‚≠ê`, 'primary');
                    roleSpeak(`That's right! It's a ${target.label}! ${target.definition}`);
                    setState({ currentGame: { ...state.currentGame, score: newScore } });
                    setTimeout(initializeShapesMatch, 3000);
                }
            } else {
                const selectedShape = shapesData.find(s => s.id === selectedId);
                handleMessage(`Oops! That's a ${selectedShape.label}. Try finding the ${target.label}.`, 'error');
                roleSpeak(`Not quite. Remember, a ${target.label} is ${target.definition}. Try again!`);
            }
        };

        const renderShapesMatch = () => {
            const { target, options, score } = state.currentGame;
            if (!target) return '';

            const optionsHTML = options.map((shape) => `
                <button data-shape-id="${shape.id}" class="check-shapes-btn flex flex-col items-center p-4 rounded-2xl shadow-xl transition-transform transform hover:scale-[1.05] border-b-4 border-anqelba-dark/50 bg-white">
                    <div class="w-24 h-24">
                        ${getShapeSVG(shape.id, 96, shape.color)}
                    </div>
                    <span class="text-xl font-bold text-anqelba-dark mt-2">${shape.label}</span>
                </button>
            `).join('');

            return `
                <div class="main-content p-4 md:p-8 bg-white rounded-3xl">
                    <h3 class="text-3xl font-black text-center text-anqelba-dark mb-4">Geometric Shapes Match</h3>

                    <div class="flex justify-between items-center mb-6 p-4 bg-gray-100 rounded-xl">
                        <p class="text-lg font-bold">Score: <span class="text-anqelba-secondary">${score} / 5</span></p>
                        <button id="backToDashboard" class="text-anqelba-dark font-semibold hover:text-anqelba-primary transition duration-200">
                            ${createIcon('ArrowLeft', 20, 'inline mr-2')} Back
                        </button>
                    </div>

                    <div class="p-8 rounded-2xl mb-8 text-center shadow-lg bg-anqelba-coral/80 text-anqelba-dark">
                        <p class="text-xl font-bold mb-2">Which shape is the:</p>
                        <div class="flex justify-center items-center">
                            <button data-speak="Which shape is the ${target.label}?" class="tts-button mr-4 cursor-pointer hover:scale-110 transition text-anqelba-dark">
                                ${createIcon('Volume2', 32)}
                            </button>
                            <p class="text-5xl font-extrabold text-anqelba-dark">${target.label}</p>
                        </div>
                        <p class="text-sm mt-2 opacity-90">${target.definition}</p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        };

        // --- RENDER AND EVENT ATTACHMENT ---

        const render = () => {
            const appDiv = document.getElementById('app');
            const { view, contrast, fontSizeLevel } = state;

            // Apply global classes
            const contrastClasses = contrast ? 'bg-black text-white' : 'bg-gray-50 text-anqelba-dark';
            const fontSizeClasses = fontSizeLevel === 2 ? 'text-lg md:text-xl' : 'text-base md:text-lg';
            appDiv.className = `min-h-screen ${contrastClasses} ${fontSizeClasses}`;

            let contentHTML = renderHeader();
            contentHTML += '<main class="container mx-auto p-2 md:p-4 main-content">';

            switch (view) {
                case 'roleSelection': contentHTML += renderRoleSelection(); break;
                case 'studentDashboard': contentHTML += renderStudentDashboard(); break;
                case 'alphabetMatch': contentHTML += renderAlphabetMatch(); break;
                case 'emotionsMatch': contentHTML += renderEmotionsMatch(); break;
                case 'countingGame': contentHTML += renderCountingGame(); break;
                case 'shapesMatch': contentHTML += renderShapesMatch(); break;
                case 'storyGeneratorView': contentHTML += renderStoryGenerator(); break; // NEW VIEW
                case 'teacherDashboard': contentHTML += renderTeacherDashboard(); break;
                default: contentHTML += renderRoleSelection(); break;
            }

            contentHTML += '</main>';
            contentHTML += renderMessageBox();

            appDiv.innerHTML = contentHTML;
            attachEventListeners();
        };

        const attachEventListeners = () => {
            // --- Global Controls ---
            document.getElementById('toggleContrast')?.addEventListener('click', () => setState({ contrast: !state.contrast }));
            document.getElementById('toggleFontSize')?.addEventListener('click', () => setState({ fontSizeLevel: state.fontSizeLevel === 1 ? 2 : 1 }));
            document.getElementById('goHome')?.addEventListener('click', () => { setState({ view: 'roleSelection', currentRole: null }); });

            // --- TTS Buttons ---
            document.querySelectorAll('.tts-button').forEach(btn => {
                btn.addEventListener('click', () => roleSpeak(btn.dataset.speak));
            });

            // --- Role Selection ---
            document.getElementById('select-student')?.addEventListener('click', () => {
                setState({ currentRole: 'student', view: 'studentDashboard' });
                roleSpeak(`Welcome to Anqelba! Let's learn and play.`);
            });
            document.getElementById('select-teacher')?.addEventListener('click', () => {
                setState({ currentRole: 'teacher', view: 'teacherDashboard' });
                handleMessage(`Welcome, Teacher. You are now in the administrative dashboard.`, 'info');
            });
            document.getElementById('teacherChangeRole')?.addEventListener('click', () => { setState({ view: 'roleSelection', currentRole: null }); });

            // --- Dashboard ---
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const lessonId = e.currentTarget.dataset.lessonId;
                    const lesson = lessons.find(l => l.id === lessonId);

                    if (lessonId === 'alphabet') {
                        setState({ view: 'alphabetMatch', currentGame: { score: 0 } });
                        initializeAlphabetMatch();
                    } else if (lessonId === 'emotions') {
                        setState({ view: 'emotionsMatch', currentGame: { score: 0 } });
                        initializeEmotionsMatch();
                    } else if (lessonId === 'counting') {
                        setState({ view: 'countingGame', currentGame: { score: 0 } });
                        initializeCountingGame(1);
                    } else if (lessonId === 'shapes') {
                        setState({ view: 'shapesMatch', currentGame: { score: 0 } });
                        initializeShapesMatch();
                    } else if (lessonId === 'storyteller') { // NEW LLM LESSON LOGIC
                        setState({ view: 'storyGeneratorView', story: { title: null, content: null, loading: false, topic: '' } });
                        roleSpeak('Tell me what kind of story you want to hear!');
                    } else {
                        handleMessage(`Lesson "${lesson.title}" is coming soon!`, 'info');
                        roleSpeak(`Lesson ${lesson.title} is coming soon!`);
                    }
                });
            });

            // --- Back Button (in Games) ---
            document.getElementById('backToDashboard')?.addEventListener('click', () => {
                setState({ view: 'studentDashboard', currentGame: { score: 0 } });
            });


            // --- Alphabet Match Game Logic ---
            document.querySelectorAll('.check-alphabet-btn').forEach(btn => {
                btn.addEventListener('click', (e) => checkAlphabetAnswer(e.currentTarget.dataset.letter));
            });

            // --- Emotions Match Game Logic ---
            document.querySelectorAll('.check-emotions-btn').forEach(btn => {
                btn.addEventListener('click', (e) => checkEmotionsAnswer(e.currentTarget.dataset.emotionId));
            });
            
            // --- Shapes Match Game Logic ---
            document.querySelectorAll('.check-shapes-btn').forEach(btn => {
                btn.addEventListener('click', (e) => checkShapesAnswer(e.currentTarget.dataset.shapeId));
            });

            // --- Counting Game Logic ---
            document.getElementById('resetBasket')?.addEventListener('click', resetBasket);
            document.getElementById('checkCountingAnswer')?.addEventListener('click', checkCountingAnswer);

            // Drag and Drop (Source)
            document.getElementById('draggableSource')?.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData("item", e.currentTarget.dataset.item);
                roleSpeak(`Picked up one ${e.currentTarget.dataset.item}`);
            });
            document.getElementById('draggableSource')?.addEventListener('touchstart', (e) => {
                // Prevent scrolling to allow for touch drag
                e.preventDefault();
                // Simple touch implementation: drop on tap (no complex touch-move drag)
                const item = e.currentTarget.dataset.item;
                setState({ currentGame: { ...state.currentGame, dropped: [...state.currentGame.dropped, item] } });
                roleSpeak(`Dropped one ${item}`);
            });
            
            // --- NEW LLM Feature Listeners ---
            document.getElementById('generateStoryBtn')?.addEventListener('click', generateStory);
            document.getElementById('generateAssessmentBtn')?.addEventListener('click', generateAssessment);

        };

        // Expose global function for the ondrop attribute in Counting Game
        window.handleDrop = handleDrop;


        // --- APPLICATION STARTUP ---
        window.onload = () => {
            if (firebaseConfig) {
                initializeFirebase();
            } else {
                console.log("Running in offline/demo mode.");
                render();
            }
        };
    </script>
</body>
</html>
