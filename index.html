<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meqenet Learner & Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons for simple, modern icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .large-touch-target {
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .section-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        /* High Contrast Mode Styles */
        body.high-contrast {
            background-color: black !important;
            color: white !important;
        }
        body.high-contrast .section-card,
        body.high-contrast .bg-white {
            background-color: black !important;
            border: 2px solid yellow !important;
            color: yellow !important;
            box-shadow: 0 0 10px yellow !important;
        }
        body.high-contrast .text-gray-900 {
            color: yellow !important;
        }
        body.high-contrast button,
        body.high-contrast a,
        body.high-contrast input,
        body.high-contrast select {
            border: 2px solid white !important;
            background-color: black !important;
            color: white !important;
        }
        body.high-contrast button:hover {
            background-color: #333 !important;
        }
        body.high-contrast .bg-indigo-600 {
            background-color: yellow !important;
            color: black !important;
            font-weight: bold;
        }
    </style>
</head>
<body id="app-body" class="bg-gray-100 text-gray-900 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-600">Meqenet Learner Hub</h1>
            <p id="user-display" class="text-sm font-medium text-gray-500 mt-1 truncate">User: Loading...</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center space-x-2 p-2 bg-white rounded-xl shadow-lg mb-6 sticky top-0 z-10">
            <button onclick="changeView('lesson')" id="nav-lesson" class="flex items-center space-x-2 large-touch-target bg-indigo-600 text-white shadow-indigo-500/50">
                <i class="ph ph-book-open text-2xl"></i>
                <span class="text-lg">Lesson</span>
            </button>
            <button onclick="changeView('quiz')" id="nav-quiz" class="flex items-center space-x-2 large-touch-target bg-gray-200 text-gray-700 hover:bg-gray-300">
                <i class="ph ph-question text-2xl"></i>
                <span class="text-lg">Quiz</span>
            </button>
            <button onclick="changeView('settings')" id="nav-settings" class="flex items-center space-x-2 large-touch-target bg-gray-200 text-gray-700 hover:bg-gray-300">
                <i class="ph ph-gear text-2xl"></i>
                <span class="text-lg">Settings</span>
            </button>
            <button onclick="changeView('management')" id="nav-management" class="flex items-center space-x-2 large-touch-target bg-gray-200 text-gray-700 hover:bg-gray-300">
                <i class="ph ph-users text-2xl"></i>
                <span class="text-lg">Manage</span>
            </button>
        </nav>

        <!-- Main Content Area -->
        <div id="content-container">
            <!-- Lesson View (Default) -->
            <section id="view-lesson" class="view-section section-card space-y-4">
                <h2 class="text-2xl font-bold border-b pb-2 mb-4 text-indigo-600">Literacy Lesson: Alphabet & Numbers</h2>
                <div class="flex space-x-2 mb-4">
                    <button onclick="loadModule('literacy')" class="px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Literacy</button>
                    <button onclick="loadModule('numeracy')" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">Numeracy</button>
                </div>

                <div id="lesson-content" class="text-base leading-relaxed space-y-3">
                    <!-- Lesson content will be dynamically inserted here -->
                </div>

                <!-- Language Selector -->
                <div class="mt-6 pt-4 border-t">
                    <label for="language-select" class="block text-lg font-medium mb-2">Select Language:</label>
                    <select id="language-select" onchange="setLanguage(this.value)" class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="en">English</option>
                        <option value="am">Amharic</option>
                    </select>
                </div>
            </section>

            <!-- Quiz View -->
            <section id="view-quiz" class="view-section section-card hidden">
                <h2 class="text-2xl font-bold border-b pb-2 mb-4 text-indigo-600">Module Quiz</h2>
                
                <div class="flex space-x-2 mb-6">
                    <button onclick="loadQuizForModule('literacy')" class="px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-700 hover:bg-indigo-200" id="quiz-module-literacy">Literacy Quiz</button>
                    <button onclick="loadQuizForModule('numeracy')" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300" id="quiz-module-numeracy">Numeracy Quiz</button>
                </div>

                <div id="quiz-container" class="space-y-6">
                    <p class="text-xl text-gray-600 text-center">Select a module above to start the quiz.</p>
                </div>
                <div id="quiz-message" class="mt-4 text-center text-xl font-bold"></div>
            </section>

            <!-- Settings View -->
            <section id="view-settings" class="view-section section-card hidden space-y-6">
                <h2 class="text-2xl font-bold border-b pb-2 mb-4 text-indigo-600">Accessibility Settings</h2>

                <!-- Contrast Mode -->
                <div>
                    <h3 class="text-xl font-semibold mb-3">Contrast Mode</h3>
                    <div class="flex space-x-4">
                        <button onclick="changeContrast('light')" data-theme-mode="light" class="p-3 rounded-xl border-2 text-sm font-medium bg-gray-100 ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">Light</button>
                        <button onclick="changeContrast('dark')" data-theme-mode="dark" class="p-3 rounded-xl border-2 text-sm font-medium bg-gray-800 text-white ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">Dark</button>
                        <button onclick="changeContrast('high')" data-theme-mode="high" class="p-3 rounded-xl border-2 text-sm font-medium bg-black text-yellow-300 ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">High Contrast</button>
                    </div>
                </div>

                <!-- Text Size -->
                <div>
                    <h3 class="text-xl font-semibold mb-3">Text Size</h3>
                    <div class="flex space-x-4">
                        <button onclick="changeTextSize('sm')" data-text-size="sm" class="p-3 rounded-xl border-2 text-sm font-medium ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">Small (A)</button>
                        <button onclick="changeTextSize('md')" data-text-size="md" class="p-3 rounded-xl border-2 text-lg font-medium ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">Medium (A)</button>
                        <button onclick="changeTextSize('lg')" data-text-size="lg" class="p-3 rounded-xl border-2 text-xl font-medium ring-4 ring-blue-500 ring-opacity-0 transition-all duration-200">Large (A)</button>
                    </div>
                </div>

                <button onclick="saveUserData()" class="large-touch-target w-full mt-6 bg-green-500 text-white hover:bg-green-600">
                    <i class="ph ph-floppy-disk text-2xl mr-2"></i> Save Settings
                </button>
                <div id="settings-message" class="mt-4 text-center font-semibold"></div>
            </section>

            <!-- Management View -->
            <section id="view-management" class="view-section section-card hidden space-y-6">
                <h2 class="text-2xl font-bold border-b pb-2 mb-4 text-indigo-600">Learner Management</h2>
                
                <!-- Add New Learner Form -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">Register New Learner</h3>
                    <form id="add-learner-form" class="space-y-4">
                        <div>
                            <label for="first-name" class="block text-sm font-medium text-gray-700">First Name</label>
                            <input type="text" id="first-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="last-name" class="block text-sm font-medium text-gray-700">Last Name</label>
                            <input type="text" id="last-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="grade-level" class="block text-sm font-medium text-gray-700">Grade Level</label>
                            <input type="number" id="grade-level" min="1" max="12" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <button type="submit" class="large-touch-target w-full bg-indigo-600 text-white hover:bg-indigo-700">
                            <i class="ph ph-user-plus text-2xl mr-2"></i> Register Learner
                        </button>
                    </form>
                    <div id="learner-form-message" class="mt-4 text-center font-semibold"></div>
                </div>

                <!-- Registered Learners List -->
                <div class="bg-white p-4 rounded-lg border">
                    <h3 class="text-xl font-semibold mb-3">Registered Learners (Your School/Group)</h3>
                    <p class="text-sm text-gray-500 mb-4">Total Learners: <span id="learner-count">0</span></p>
                    <div id="learners-list" class="space-y-3">
                        <!-- Learner items will be inserted here -->
                        <p id="loading-learners" class="text-center text-gray-500">Loading learners...</p>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Must be used) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-learner-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Firestore Path Helpers
        const getUserSettingsDocPath = (uid) => `/artifacts/${appId}/users/${uid}/appData/settings`;
        const getLearnersCollectionPath = (uid) => `/artifacts/${appId}/users/${uid}/learners`;

        // --- APPLICATION STATE ---
        let appState = {
            view: 'lesson',
            module: 'literacy',
            language: 'en',
            contrastMode: 'light',
            textSize: 'md',
        };

        const LESSON_CONTENT = {
            literacy: {
                en: "<h1>The English Alphabet</h1><p>The English alphabet has 26 letters. We use these letters to read and write words. Understanding the letters is the first step to literacy. Let's learn A-Z!</p><h3>A is for Apple</h3><p>An apple is a common fruit.</p><h3>B is for Ball</h3><p>A ball is used for games.</p><h2>Try the Quiz!</h2><p>Click the Quiz tab to test your knowledge on letters.</p>",
                am: "<h1>·ã®·ä•·äï·åç·àä·ãò·äõ ·çä·ã∞·àã·âµ (Literacy)</h1><p>·ã®·ä•·äï·åç·àä·ãò·äõ ·çä·ã∞·àã·âµ 26 ·äì·â∏·ãç·ç¢ ·âÉ·àã·âµ·äï ·àà·àõ·äï·â†·â• ·ä•·äì ·àà·àò·åª·çç ·ä•·äï·å†·âÄ·àù·â£·â∏·ãã·àà·äï·ç¢ ·çä·ã∞·àã·âµ·äï ·àò·à®·ã≥·âµ ·àà·àò·åª·çç·äì ·àà·àõ·äï·â†·â• ·ã®·àò·åÄ·àò·à™·ã´·ãç ·ä•·à≠·àù·åÉ ·äê·ãç·ç¢ ·ä® A-Z ·ä•·äï·àõ·à≠!</p><h3>A ·àà·ä†·çï·àç (Apple) ·äê·ãç</h3><p>·ä†·çï·àç ·ã®·â∞·àà·àò·ã∞ ·çç·à¨ ·äê·ãç·ç¢</p><h3>B ·àà·â¶·àç (Ball) ·äê·ãç</h3><p>·ä≥·àµ ·àà·å®·ãã·â≥ ·ã≠·ãç·àã·àç·ç¢</p><h2>·çà·â∞·äì·ãç·äï ·ã≠·àû·ä≠·à©!</h2><p>·àµ·àà ·çä·ã∞·àã·âµ ·ã´·àà·ãé·âµ·äï ·ä•·ãç·âÄ·âµ ·àà·àò·çà·â∞·àΩ ·ã®·çà·â∞·äì ·âµ·à©·äï ·ã≠·å´·äë·ç¢</p>"
            },
            numeracy: {
                en: "<h1>Numeracy Lesson: Numbers 1-10</h1><p>Numeracy is about understanding numbers and counting. Counting helps us keep track of quantities. Let's learn 1-10!</p><h3>1 (One)</h3><p>One sun, one moon.</p><h3>2 (Two)</h3><p>Two hands, two feet.</p><h2>Try the Quiz!</h2><p>Click the Quiz tab to test your knowledge on numbers.</p>",
                am: "<h1>·ã®·âÅ·å•·à≠ ·âµ·àù·àÖ·à≠·âµ (Numeracy)·ç° ·âÅ·å•·àÆ·âΩ 1-10</h1><p>·ã®·âÅ·å•·à≠ ·âµ·àù·àÖ·à≠·âµ ·âÅ·å•·àÆ·âΩ·äï ·ä•·äì ·àò·âÅ·å†·à≠·äï ·àò·à®·ã≥·âµ ·äê·ãç·ç¢ ·àò·âÅ·å†·à≠ ·àò·å†·äñ·âΩ·äï ·ä•·äï·ãµ·äï·ä®·â≥·â∞·àç ·ã≠·à®·ã≥·äì·àç·ç¢ ·ä® 1-10 ·ä•·äï·àõ·à≠!</p><h3>1 (·ä†·äï·ãµ)</h3><p>·ä†·äï·ãµ ·çÄ·àê·ã≠·ç£ ·ä†·äï·ãµ ·å®·à®·âÉ·ç¢</p><h3>2 (·àÅ·àà·âµ)</h3><p>·àÅ·àà·âµ ·ä•·åÜ·âΩ·ç£ ·àÅ·àà·âµ ·ä•·åç·àÆ·âΩ·ç¢</p><h2>·çà·â∞·äì·ãç·äï ·ã≠·àû·ä≠·à©!</h2><p>·àµ·àà ·âÅ·å•·àÆ·âΩ ·ã´·àà·ãé·âµ·äï ·ä•·ãç·âÄ·âµ ·àà·àò·çà·â∞·àΩ ·ã®·çà·â∞·äì ·âµ·à©·äï ·ã≠·å´·äë·ç¢</p>"
            }
        };

        const QUIZ_QUESTIONS = {
            literacy: [
                { id: 1, question: "Which letter comes after 'C'?", options: [{ text: "A. D", correct: true }, { text: "B. B", correct: false }, { text: "C. E", correct: false }], answer: 'A' },
                { id: 2, question: "What is the first letter of 'Zebra'?", options: [{ text: "A. X", correct: false }, { text: "B. Z", correct: true }, { text: "C. S", correct: false }], answer: 'B' },
            ],
            numeracy: [
                { id: 1, question: "How many fingers do you have on one hand?", options: [{ text: "A. Four", correct: false }, { text: "B. Five", correct: true }, { text: "C. Ten", correct: false }], answer: 'B' },
                { id: 2, question: "What number comes after 9?", options: [{ text: "A. 8", correct: false }, { text: "B. 10", correct: true }, { text: "C. 11", correct: false }], answer: 'B' },
            ]
        };
        let currentQuizIndex = 0;
        let currentQuizModule = 'literacy';


        // --- FIREBASE AND DATA MANAGEMENT ---

        async function setupFirebase() {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config is missing.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-display').textContent = `User: ${userId.substring(0, 8)}...`;
                        console.log("Firebase Auth State Changed: User logged in.", userId);
                        await loadUserData();
                        startLearnersListener(); // Start listening to learner data
                    } else {
                        // Sign in anonymously if no token, otherwise attempt with token
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error setting up Firebase:", error);
            }
        }

        async function loadUserData() {
            if (!userId) {
                console.error("User ID not available to load data.");
                return;
            }

            try {
                const settingsDocRef = doc(db, getUserSettingsDocPath(userId));
                const docSnap = await getDoc(settingsDocRef);

                if (docSnap.exists()) {
                    const savedSettings = docSnap.data();
                    console.log("Settings loaded from Firestore:", savedSettings);

                    // Update local state
                    appState = {
                        ...appState,
                        view: savedSettings.view || appState.view,
                        module: savedSettings.module || appState.module,
                        language: savedSettings.language || appState.language,
                        contrastMode: savedSettings.contrastMode || appState.contrastMode,
                        textSize: savedSettings.textSize || appState.textSize,
                    };
                } else {
                    console.log("No user settings found, using defaults.");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                // The original error was: Cannot read properties of null (reading 'dataset')
                // This fix relies on DOMContentLoaded check which ensures the elements are present.
            }
            
            // Apply initial state to the DOM AFTER loading or using defaults.
            applyTheme(appState.contrastMode);
            applyTextSize(appState.textSize);
            loadModule(appState.module); 
            setLanguage(appState.language);
            changeView(appState.view);
        }

        async function saveUserData() {
            if (!userId) {
                console.error("User ID not available to save data.");
                return;
            }

            try {
                const settingsDocRef = doc(db, getUserSettingsDocPath(userId));
                await setDoc(settingsDocRef, appState, { merge: true });
                showSettingsFeedback("‚úÖ Settings saved successfully!", 'success');
            } catch (error) {
                console.error("Error saving user data:", error);
                showSettingsFeedback("‚ùå Failed to save settings. Check console.", 'error');
            }
        }
        
        // Learner Management Functions
        let learnersUnsubscribe = null;

        function startLearnersListener() {
            if (learnersUnsubscribe) learnersUnsubscribe();

            if (!db || !userId) {
                console.error("Database or User ID not ready for listener.");
                return;
            }

            const learnersColRef = collection(db, getLearnersCollectionPath(userId));
            const q = query(learnersColRef);

            learnersUnsubscribe = onSnapshot(q, (snapshot) => {
                const learners = [];
                snapshot.forEach(doc => {
                    learners.push({ id: doc.id, ...doc.data() });
                });
                renderLearners(learners);
            }, (error) => {
                console.error("Error listening to learners:", error);
                document.getElementById('loading-learners').textContent = "Failed to load learners.";
            });
        }

        function renderLearners(learners) {
            const listEl = document.getElementById('learners-list');
            document.getElementById('learner-count').textContent = learners.length;
            
            listEl.innerHTML = ''; // Clear existing list
            
            if (learners.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500">No learners registered yet.</p>';
                return;
            }

            // Sort by first name
            learners.sort((a, b) => a.firstName.localeCompare(b.firstName));

            learners.forEach(learner => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-white rounded-lg border shadow-sm';
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-lg font-semibold">${learner.firstName} ${learner.lastName}</p>
                        <p class="text-sm text-gray-500">Grade: ${learner.gradeLevel} | ID: ${learner.id.substring(0, 8)}...</p>
                    </div>
                    <div>
                        <button onclick="deleteLearner('${learner.id}')" class="p-2 text-red-600 hover:text-red-800 transition-colors">
                            <i class="ph ph-trash text-xl"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        async function deleteLearner(learnerId) {
             if (!userId || !learnerId) return;

             // Use a simple prompt/confirm flow without external libraries
             if (!window.confirm(`Are you sure you want to delete learner ID ${learnerId.substring(0, 5)}...?`)) {
                return;
             }

             try {
                const learnerDocRef = doc(db, getLearnersCollectionPath(userId), learnerId);
                await deleteDoc(learnerDocRef);
                showFormFeedback(`üóëÔ∏è Learner deleted! ID: ${learnerId.substring(0, 5)}...`, 'info');
            } catch (error) {
                console.error("Error deleting learner:", error);
                showFormFeedback("‚ùå Failed to delete learner. Check console for details.", 'error');
            }
        }


        // --- UI & ACCESSIBILITY FUNCTIONS ---

        function applyTheme(mode) {
            const body = document.getElementById('app-body');
            if (!body) return; // Null check added for safety

            // Apply base contrast class
            body.className = body.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && c !== 'dark-mode' && c !== 'high-contrast').join(' ');
            
            if (mode === 'dark') {
                body.classList.add('bg-gray-900', 'text-gray-100', 'dark-mode');
            } else if (mode === 'high') {
                body.classList.add('high-contrast');
            } else { // light
                body.classList.add('bg-gray-100', 'text-gray-900');
            }

            // Update button visual state
            const themeButtons = document.querySelectorAll('[data-theme-mode]');
            if (themeButtons.length > 0) { // Robustness check
                themeButtons.forEach(btn => {
                    const btnMode = btn.dataset.themeMode;
                    btn.classList.remove('ring-4', 'ring-blue-500', 'ring-indigo-500');
                    if (btnMode === mode) {
                        btn.classList.add('ring-4', 'ring-blue-500');
                    }
                });
            }
        }

        function applyTextSize(size) {
            const body = document.getElementById('app-body');
            if (!body) return; // Null check added for safety

            // Remove existing text-size classes
            body.className = body.className.split(' ').filter(c => !c.startsWith('text-')).join(' ');

            if (size === 'sm') {
                body.classList.add('text-sm');
            } else if (size === 'lg') {
                body.classList.add('text-lg');
            } else { // md
                body.classList.add('text-base');
            }

            // Update button visual state
            const sizeButtons = document.querySelectorAll('[data-text-size]');
            if (sizeButtons.length > 0) { // Robustness check
                 sizeButtons.forEach(btn => {
                    const btnSize = btn.dataset.textSize;
                    btn.classList.remove('ring-4', 'ring-blue-500', 'ring-indigo-500');
                    if (btnSize === size) {
                        btn.classList.add('ring-4', 'ring-blue-500');
                    }
                });
            }
        }

        function changeContrast(mode) {
            appState.contrastMode = mode;
            applyTheme(mode);
        }

        function changeTextSize(size) {
            appState.textSize = size;
            applyTextSize(size);
        }
        
        function changeView(newView) {
            appState.view = newView;
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('bg-indigo-600', 'text-white', 'shadow-indigo-500/50');
                button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });

            document.getElementById(`view-${newView}`).classList.remove('hidden');
            document.getElementById(`nav-${newView}`).classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            document.getElementById(`nav-${newView}`).classList.add('bg-indigo-600', 'text-white', 'shadow-indigo-500/50');
            
            // Re-load content on view change if necessary (e.g., to reset quiz)
            if (newView === 'lesson') {
                loadModule(appState.module);
            } else if (newView === 'quiz') {
                loadQuizForModule(currentQuizModule);
            }
        }


        // --- LESSON & QUIZ LOGIC ---

        function loadModule(module) {
            appState.module = module;
            const lessonContentEl = document.getElementById('lesson-content');
            
            // Set lesson content
            const content = LESSON_CONTENT[module][appState.language] || LESSON_CONTENT[module]['en'];
            lessonContentEl.innerHTML = content;
            
            // Update button styles
            document.querySelectorAll('#view-lesson button').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700');
                btn.classList.add('bg-gray-200', 'text-gray-700');
                if (btn.textContent.toLowerCase().includes(module)) {
                     btn.classList.remove('bg-gray-200', 'text-gray-700');
                     btn.classList.add('bg-indigo-100', 'text-indigo-700');
                }
            });
        }

        function setLanguage(lang) {
            appState.language = lang;
            document.getElementById('language-select').value = lang;
            
            // Reload the current module content in the new language
            loadModule(appState.module); 

            // Note: Quiz questions are not translated in this simple demo.
        }

        function loadQuizForModule(module) {
            currentQuizModule = module;
            currentQuizIndex = 0;
            const quizContainer = document.getElementById('quiz-container');
            
            document.getElementById('quiz-message').textContent = '';

            // Update button styles
            document.querySelectorAll('#view-quiz button').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`quiz-module-${module}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`quiz-module-${module}`).classList.add('bg-indigo-100', 'text-indigo-700');


            if (QUIZ_QUESTIONS[module].length === 0) {
                quizContainer.innerHTML = `<p class="text-xl text-center text-red-600">No quiz available for ${module}.</p>`;
                return;
            }

            renderQuizQuestion(QUIZ_QUESTIONS[module][currentQuizIndex]);
        }

        function renderQuizQuestion(questionData) {
            const quizContainer = document.getElementById('quiz-container');
            
            let html = `
                <h3 class="text-2xl font-bold mb-4 text-center">Question ${currentQuizIndex + 1} of ${QUIZ_QUESTIONS[currentQuizModule].length}</h3>
                <div class="bg-indigo-50 p-6 rounded-xl border-l-4 border-indigo-500 shadow-md">
                    <p class="text-xl font-semibold">${questionData.question}</p>
                </div>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <!-- Options buttons will go here -->
                </div>
            `;
            quizContainer.innerHTML = html;

            const optionsContainer = document.getElementById('options-container');
            
            questionData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = 'large-touch-target bg-white text-gray-800 border-2 border-gray-300 hover:bg-indigo-100 shadow-md transition-all duration-150';
                // Attach correct choice logic to the button's onclick
                button.onclick = () => handleQuizSelection(option.correct);
                optionsContainer.appendChild(button);
            });
        }

        function handleQuizSelection(isCorrect) {
            if (isCorrect) {
                showFeedback("‚úÖ Correct! Good job!", 'success');
            } else {
                showFeedback("‚ùå Incorrect. Try again!", 'error');
            }

            // Move to next question after a brief delay
            setTimeout(() => {
                currentQuizIndex++;
                if (currentQuizIndex < QUIZ_QUESTIONS[currentQuizModule].length) {
                    renderQuizQuestion(QUIZ_QUESTIONS[currentQuizModule][currentQuizIndex]);
                } else {
                    document.getElementById('quiz-container').innerHTML = `
                        <p class="text-3xl font-bold text-center text-green-600">Quiz Complete!</p>
                        <p class="text-xl text-center mt-4">You have finished the ${currentQuizModule} quiz. Great work!</p>
                        <button onclick="loadQuizForModule('${currentQuizModule}')" class="large-touch-target w-full mt-6 bg-indigo-600 text-white hover:bg-indigo-700">Restart Quiz</button>
                    `;
                }
            }, 1500);
        }

        function showFeedback(message, type) {
            const quizMessage = document.getElementById('quiz-message');
            quizMessage.textContent = message;
            
            if (type === 'success') {
                quizMessage.className = 'mt-4 text-center text-3xl font-bold text-green-600';
            } else if (type === 'error') {
                quizMessage.className = 'mt-4 text-center text-3xl font-bold text-red-600';
            } else { // info
                quizMessage.className = 'mt-4 text-center text-3xl font-bold text-blue-600';
            }

            // Clear message after 3 seconds
            setTimeout(() => {
                quizMessage.textContent = '';
                quizMessage.className = 'mt-4 text-center text-xl font-bold';
            }, 3000);
        }

        function showSettingsFeedback(message, type) {
            const settingsMessageEl = document.getElementById('settings-message');
            settingsMessageEl.textContent = message;
            
            if (type === 'success') {
                settingsMessageEl.className = 'mt-4 text-center font-semibold text-green-600';
            } else if (type === 'error') {
                settingsMessageEl.className = 'mt-4 text-center font-semibold text-red-600';
            } else { // info
                settingsMessageEl.className = 'mt-4 text-center font-semibold text-blue-600';
            }

            setTimeout(() => {
                settingsMessageEl.textContent = '';
                settingsMessageEl.className = 'mt-4 text-center font-semibold';
            }, 5000);
        }

        // Learner Form Submission
        document.addEventListener('submit', async (e) => {
            if (e.target.id !== 'add-learner-form') return;
            e.preventDefault();

            if (!userId) {
                showFormFeedback("Authentication not ready. Please wait.", 'error');
                return;
            }

            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const gradeLevel = parseInt(document.getElementById('grade-level').value, 10);

            if (!firstName || !lastName || isNaN(gradeLevel)) {
                showFormFeedback("Please fill out all fields correctly.", 'error');
                return;
            }

            try {
                const learnersColRef = collection(db, getLearnersCollectionPath(userId));
                const newLearner = {
                    firstName,
                    lastName,
                    gradeLevel,
                    registeredBy: userId,
                    createdAt: new Date().toISOString()
                };
                
                const docRef = await addDoc(learnersColRef, newLearner);
                showFormFeedback(`üéâ Learner registered! ID: ${docRef.id.substring(0, 5)}...`, 'success');
                document.getElementById('add-learner-form').reset();
            } catch (error) {
                console.error("Error adding new learner:", error);
                showFormFeedback("‚ùå Failed to register learner. Check console for details.", 'error');
            }
        });

        function showFormFeedback(message, type) {
            const formMessageEl = document.getElementById('learner-form-message');
            formMessageEl.textContent = message;
            
            if (type === 'success') {
                formMessageEl.className = 'mt-4 text-center font-semibold text-green-600';
            } else if (type === 'error') {
                formMessageEl.className = 'mt-4 text-center font-semibold text-red-600';
            } else { // info
                formMessageEl.className = 'mt-4 text-center font-semibold text-blue-600';
            }

            setTimeout(() => {
                formMessageEl.textContent = '';
                formMessageEl.className = 'mt-4 text-center font-semibold';
            }, 5000);
        }

        // --- GLOBAL EXPOSURE FOR INLINE HANDLERS (FIX for ReferenceError) ---
        
        // Expose Firebase functions (less critical for inline, but safe practice)
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.getDocs = getDocs;

        // Expose Core App Functions (Critical for inline HTML event handlers)
        window.loadModule = loadModule;
        window.setLanguage = setLanguage;
        window.changeView = changeView;
        window.changeContrast = changeContrast;
        window.changeTextSize = changeTextSize;
        window.saveUserData = saveUserData;
        window.applyTheme = applyTheme;
        window.applyTextSize = applyTextSize;
        window.handleQuizSelection = handleQuizSelection;
        window.loadQuizForModule = loadQuizForModule;
        window.deleteLearner = deleteLearner; // For management view

        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Meqenet Learner App DOM loaded. Starting Firebase setup.");
            setupFirebase(); 
            // Theme application now happens *after* Firebase auth/data load in loadUserData()
            // which ensures DOM is ready and data is available for initial state.
        });
        
    </script>
</body>
</html>
