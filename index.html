<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meqenet Learner & Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            /* Disable text selection for touch apps */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Style for large, touch-friendly interactive elements */
        .large-touch-target {
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            cursor: pointer;
        }
        /* Card styling for content sections */
        .section-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Highlight for the currently selected letter/number */
        .current-item {
            transform: scale(1.1);
            border-color: #4f46e5; /* indigo-600 */
        }
    </style>
    <script>
        // --- Global State and Initialization ---
        // Global variables for Firebase access (MUST be defined)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-meqenet-learner';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // App State
        const appState = {
            module: 'literacy', // literacy, numeracy, life_skills
            language: 'english', // english, amharic
            contrastMode: 'normal', // normal, high_contrast
            textSize: 'medium', // small, medium, large
            currentView: 'lesson', // lesson, quiz, management, settings
            currentLiteracyIndex: 0,
            currentNumeracyIndex: 0,
            learnerData: [] // Array to hold Firestore learner documents
        };

        // --- Content Definitions (Lessons and Quizzes) ---
        const CONTENT = {
            literacy: {
                title: { english: "Literacy: The Alphabet (A-Z)", amharic: "á‹¨áŠ áŠ•á‰¥á‰¦ áˆ˜áŒ»á á‰µáˆáˆ…áˆ­á‰µ: áŠá‹°áˆ‹á‰µ (áŠ¨A-Z)" },
                items: [
                    { value: 'A', example: { english: 'Apple', amharic: 'áŠ á•áˆ' }, quiz: { question: 'What starts with A?', options: [{ text: 'Ball', correct: false }, { text: 'Ant', correct: true }, { text: 'Cat', correct: false }] } },
                    { value: 'B', example: { english: 'Ball', amharic: 'áŠ³áˆµ' }, quiz: { question: 'What is B?', options: [{ text: 'Ball', correct: true }, { text: 'Dog', correct: false }, { text: 'Egg', correct: false }] } },
                    { value: 'C', example: { english: 'Cat', amharic: 'á‹µáˆ˜á‰µ' }, quiz: { question: 'C is for?', options: [{ text: 'Fan', correct: false }, { text: 'Cat', correct: true }, { text: 'Goat', correct: false }] } },
                    { value: 'D', example: { english: 'Dog', amharic: 'á‹áˆ»' }, quiz: { question: 'Which is D?', options: [{ text: 'Hat', correct: false }, { text: 'Dog', correct: true }, { text: 'Ink', correct: false }] } },
                ].concat(Array.from({ length: 22 }, (_, i) => {
                    const charCode = 'E'.charCodeAt(0) + i;
                    const char = String.fromCharCode(charCode);
                    return { value: char, example: { english: `Example for ${char}`, amharic: `${char} áˆáˆ³áˆŒ` }, quiz: { question: `Quiz for ${char}?`, options: [{ text: `Option 1`, correct: false }, { text: char, correct: true }, { text: `Option 3`, correct: false }] } };
                }))
            },
            numeracy: {
                title: { english: "Numeracy: Numbers (1-10)", amharic: "á‹¨á‰áŒ¥áˆ­ á‰µáˆáˆ…áˆ­á‰µ: á‰áŒ¥áˆ®á‰½ (áŠ¨1-10)" },
                items: Array.from({ length: 10 }, (_, i) => ({
                    value: (i + 1).toString(), 
                    example: { english: `You have ${i + 1} fingers.`, amharic: `${i + 1} áŒ£á‰¶á‰½ áŠ áˆ‰á‹Žá‰µá¢` },
                    quiz: { question: `What number is ${i + 1}?`, options: [
                        { text: (i).toString(), correct: false }, 
                        { text: (i + 1).toString(), correct: true }, 
                        { text: (i + 2).toString(), correct: false }
                    ]}
                }))
            },
            life_skills: {
                title: { english: "Life Skills: Daily Routines", amharic: "á‹¨áˆ…á‹­á‹ˆá‰µ áŠ­áˆ…áˆŽá‰¶á‰½: á‹¨á‹•áˆˆá‰µ á‰°á‹•áˆˆá‰µ á‰°áŒá‰£áˆ«á‰µ" },
                items: [
                    { value: 'Wake Up', example: { english: 'Start the day!', amharic: 'á‰€áŠ‘áŠ• á‹­áŒ€áˆáˆ©!' }, quiz: { question: 'When do you brush your teeth?', options: [{ text: 'Before bed', correct: true }, { text: 'Before waking up', correct: false }] } },
                    { value: 'Eat Food', example: { english: 'Time to eat!', amharic: 'á‹¨áˆ˜á‰¥áˆ‹á‰µ áŒŠá‹œ!' }, quiz: { question: 'Why do we eat?', options: [{ text: 'For energy', correct: true }, { text: 'To sleep', correct: false }] } },
                    { value: 'Play', example: { english: 'Have fun!', amharic: 'á‹­á‹áŠ“áŠ‘!' }, quiz: { question: 'Is playing good for learning?', options: [{ text: 'Yes', correct: true }, { text: 'No', correct: false }] } },
                ]
            }
        };

        const TEXT = {
            nav: {
                lesson: { english: 'Lesson', amharic: 'á‰µáˆáˆ…áˆ­á‰µ' },
                quiz: { english: 'Quiz', amharic: 'áˆá‰°áŠ“' },
                management: { english: 'Learner Management', amharic: 'á‰°áˆ›áˆª áŠ áˆµá‰°á‹³á‹°áˆ­' },
                settings: { english: 'Settings', amharic: 'á‰…áŠ•á‰¥áˆ®á‰½' },
            },
            literacy_module: { english: 'Literacy Module', amharic: 'á‹¨áŠ áŠ•á‰¥á‰¦ áˆ˜áŒ»á áˆžá‹±áˆ' },
            numeracy_module: { english: 'Numeracy Module', amharic: 'á‹¨á‰áŒ¥áˆ­ áˆžá‹±áˆ' },
            life_skills_module: { english: 'Life Skills Module', amharic: 'á‹¨áˆ…á‹­á‹ˆá‰µ áŠ­áˆ…áˆŽá‰µ áˆžá‹±áˆ' },
            next: { english: 'Next', amharic: 'á‰€áŒ¥áˆŽ' },
            previous: { english: 'Previous', amharic: 'á‰€á‹°áˆ áˆ²áˆ' },
            speak_word: { english: 'Speak Word', amharic: 'á‰ƒáˆ‰áŠ• á‰°áŠ“áŒˆáˆ­' },
            example: { english: 'Example Word:', amharic: 'áˆáˆ³áˆŒ á‰ƒáˆ:' },
            quiz_question: { english: 'Quiz Question:', amharic: 'á‹¨áˆá‰°áŠ“ áŒ¥á‹«á‰„:' },
            correct: { english: 'âœ… Correct! Well done!', amharic: 'âœ… á‰µáŠ­áŠ­áˆ! áŒŽá‰ á‹!' },
            incorrect: { english: 'âŒ Incorrect. Try again!', amharic: 'âŒ áˆµáˆ…á‰°á‰µá¢ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áˆžáŠ­áˆ©!' },
            register_learner: { english: 'Register New Learner', amharic: 'áŠ á‹²áˆµ á‰°áˆ›áˆª áŠ áˆµáˆ˜á‹áŒá‰¥' },
            first_name: { english: 'First Name', amharic: 'áˆµáˆ' },
            last_name: { english: 'Last Name', amharic: 'á‹¨áŠ á‰£á‰µ áˆµáˆ' },
            grade: { english: 'Grade Level (1-8)', amharic: 'á‹¨áŠ­ááˆ á‹°áˆ¨áŒƒ (1-8)' },
            learner_id: { english: 'Unique ID (Optional)', amharic: 'áˆá‹© áˆ˜áˆˆá‹« (áŠ áˆ›áˆ«áŒ­)' },
            submit: { english: 'Register Learner', amharic: 'á‰°áˆ›áˆªáŠ• áŠ áˆµáˆ˜á‹áŒá‰¥' },
            current_learners: { english: 'Current Learners', amharic: 'áŠ áˆáŠ• á‹«áˆ‰ á‰°áˆ›áˆªá‹Žá‰½' },
            voice_settings: { english: 'Voice Settings', amharic: 'á‹¨á‹µáˆáŒ½ á‰…áŠ•á‰¥áˆ®á‰½' },
            select_voice: { english: 'Select Voice', amharic: 'á‹µáˆáŒ½ áˆáˆ¨áŒ¥' },
            rate: { english: 'Speed (Rate)', amharic: 'ááŒ¥áŠá‰µ (á‹°áˆ¨áŒƒ)' },
            pitch: { english: 'Pitch', amharic: 'á‹µáˆáŒ½ (á’á‰½)' },
            accessibility: { english: 'Accessibility Settings', amharic: 'á‰°á‹°áˆ«áˆ½áŠá‰µ á‰…áŠ•á‰¥áˆ®á‰½' },
            contrast: { english: 'Contrast Mode', amharic: 'á‹¨áŠ•á…á…áˆ­ áˆáŠá‰³' },
            text_size: { english: 'Text Size', amharic: 'á‹¨áŒ½áˆ‘á áˆ˜áŒ áŠ•' },
            normal: { english: 'Normal', amharic: 'áˆ˜á‹°á‰ áŠ›' },
            high_contrast: { english: 'High Contrast', amharic: 'áŠ¨áá‰°áŠ› áŠ•á…á…áˆ­' },
            small: { english: 'Small', amharic: 'á‰µáŠ•áˆ½' },
            medium: { english: 'Medium', amharic: 'áˆ˜áŠ«áŠ¨áˆˆáŠ›' },
            large: { english: 'Large', amharic: 'á‰µáˆá‰…' },
            delete: { english: 'Delete', amharic: 'áŠ áŒ¥á‹' }
        };

        // --- Firebase Setup ---
        let db, auth;
        let userId = null; 
        let authReady = false;

        // Utility function to convert Amharic text to its English phonetic equivalent for TTS if necessary
        function ttsPhoneticAmharic(text) {
            // This is a complex problem, but for a simplified demo, we can map common Amharic characters.
            // A real solution would use a dedicated TTS model or SSML.
            const phoneticMap = {
                'áŠ ': 'A', 'á‰ ': 'Be', 'áŒˆ': 'Ge', 'á‹°': 'De', 'á‹¨': 'Ye', 'áˆ­': 'R', 'á‰¥': 'B', 'áˆµ': 'S', 'á‰µ': 'T', 'áˆ': 'M', 'áˆ': 'L', 'á‹Ž': 'Wo', 'áŒ¥': 'T', 'á‰': 'Ku', 'áˆ½': 'Sh', 'áŠ­': 'K', 'á‰½': 'Ch', 'áˆ…': 'H', 'á‹­': 'Y' 
            };
            let phonetic = text;
            for (const amh in phoneticMap) {
                phonetic = phonetic.replace(new RegExp(amh, 'g'), phoneticMap[amh]);
            }
            return phonetic;
        }

        // --- Internationalization (i18n) Helper ---
        function t(key) {
            return TEXT[key][appState.language] || TEXT[key]['english'];
        }

        function getLessonContent() {
            const moduleContent = CONTENT[appState.module];
            if (!moduleContent) return null;

            let index = 0;
            if (appState.module === 'literacy') {
                index = appState.currentLiteracyIndex;
            } else if (appState.module === 'numeracy') {
                index = appState.currentNumeracyIndex;
            } else if (appState.module === 'life_skills') {
                // Life skills can also use an index
                index = appState.currentLifeSkillsIndex || 0;
            }
            return moduleContent.items[index];
        }

        // --- TTS and Voice Functions ---
        let currentSynth;
        let availableVoices = [];

        function initializeTTS() {
            if (currentSynth) return;
            currentSynth = window.speechSynthesis;
            if (currentSynth) {
                // Wait for voices to be loaded
                currentSynth.onvoiceschanged = () => {
                    availableVoices = currentSynth.getVoices();
                    populateVoiceSelect();
                };
                // In case voices are already loaded
                availableVoices = currentSynth.getVoices();
                if (availableVoices.length > 0) {
                    populateVoiceSelect();
                }
            } else {
                console.error("Speech Synthesis not supported in this browser.");
            }
        }

        function populateVoiceSelect() {
            const voiceSelect = document.getElementById('voice-select');
            if (!voiceSelect) return;

            // Clear existing options
            voiceSelect.innerHTML = '';
            
            // Filter for English and Amharic voices if possible, otherwise use all.
            const filteredVoices = availableVoices.filter(voice => 
                voice.lang.startsWith('en-') || voice.lang.startsWith('am-')
            );

            // Add an 'Auto' option
            const defaultOption = document.createElement('option');
            defaultOption.textContent = 'Auto (Browser Default)';
            defaultOption.value = '';
            voiceSelect.appendChild(defaultOption);

            // Add filtered or all voices
            (filteredVoices.length > 0 ? filteredVoices : availableVoices).forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                // Pre-select a reasonable default if available, otherwise just use 'Auto'
                if (voice.default && !appState.voiceName) {
                    appState.voiceName = voice.name;
                    option.selected = true;
                }
                voiceSelect.appendChild(option);
            });
        }

        function speak(text) {
            if (!currentSynth) {
                console.error("TTS not ready.");
                return;
            }
            
            // Clear any existing utterance
            currentSynth.cancel(); 

            const utterance = new SpeechSynthesisUtterance(text);
            
            // Apply settings from state
            const voiceName = appState.voiceName;
            if (voiceName) {
                utterance.voice = availableVoices.find(voice => voice.name === voiceName) || null;
            }

            utterance.rate = parseFloat(document.getElementById('voice-rate').value) || 0.6; // Slower, clearer rate
            utterance.pitch = parseFloat(document.getElementById('voice-pitch').value) || 1.0; 
            
            // Set language hint based on app language
            if (appState.language === 'amharic') {
                 // For Amharic, use the content in Amharic and hint the lang if possible
                 utterance.lang = 'am-ET';
            } else {
                 utterance.lang = 'en-US';
            }


            // Speak the text
            currentSynth.speak(utterance);
        }

        // --- UI Rendering Functions ---

        function renderLessonView() {
            const content = getLessonContent();
            const lessonView = document.getElementById('lesson-view');
            
            if (!content) {
                lessonView.innerHTML = `<p class="text-center text-xl text-gray-500">${t('normal')}</p>`;
                return;
            }

            // Get the current index for the navigation logic
            let currentIndex = 0;
            let totalItems = 0;
            if (appState.module === 'literacy') {
                currentIndex = appState.currentLiteracyIndex;
                totalItems = CONTENT.literacy.items.length;
            } else if (appState.module === 'numeracy') {
                currentIndex = appState.currentNumeracyIndex;
                totalItems = CONTENT.numeracy.items.length;
            } else if (appState.module === 'life_skills') {
                currentIndex = appState.currentLifeSkillsIndex || 0;
                totalItems = CONTENT.life_skills.items.length;
            }

            const currentTitle = CONTENT[appState.module].title[appState.language];
            const currentItem = content.value;
            const currentExample = content.example[appState.language];
            
            lessonView.innerHTML = `
                <div class="section-card bg-indigo-50 border border-indigo-200 text-center mb-6">
                    <h3 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-2">${currentTitle}</h3>
                    <p class="text-gray-600">${currentIndex + 1} / ${totalItems}</p>
                </div>

                <div class="text-center p-8 bg-white border-4 border-indigo-500 rounded-2xl shadow-xl transition-all current-item">
                    <div class="${appState.textSize === 'large' ? 'text-8xl' : appState.textSize === 'medium' ? 'text-7xl' : 'text-6xl'} font-extrabold text-indigo-900 mb-6">${currentItem}</div>
                    <p class="text-2xl font-semibold text-gray-700 mb-6">${t('example')} <span class="font-extrabold text-indigo-800">${currentExample}</span></p>
                    
                    <button id="speak-button" class="large-touch-target bg-green-500 hover:bg-green-600 active:bg-green-700 text-white shadow-lg w-full max-w-sm mx-auto flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"></path></svg>
                        ${t('speak_word')}
                    </button>
                </div>

                <div class="flex justify-between mt-8">
                    <button id="prev-button" class="large-touch-target bg-gray-200 hover:bg-gray-300 active:bg-gray-400 text-gray-800 flex-1 mr-4 ${currentIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentIndex === 0 ? 'disabled' : ''}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        ${t('previous')}
                    </button>
                    <button id="next-button" class="large-touch-target bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 text-white flex-1 ml-4 ${currentIndex === totalItems - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentIndex === totalItems - 1 ? 'disabled' : ''}>
                        ${t('next')}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 ml-2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            `;
            
            // Attach event listeners
            document.getElementById('speak-button').onclick = () => speak(currentItem + ' for ' + currentExample);
            document.getElementById('prev-button').onclick = () => navigateLesson('prev');
            document.getElementById('next-button').onclick = () => navigateLesson('next');
        }

        function renderQuizView() {
            const content = getLessonContent();
            const quizView = document.getElementById('quiz-view');
            
            if (!content || !content.quiz) {
                quizView.innerHTML = `<p class="text-center text-xl text-gray-500">${t('normal')}</p>`;
                return;
            }

            const question = content.quiz.question;
            const options = content.quiz.options;

            quizView.innerHTML = `
                <div class="section-card bg-yellow-50 border border-yellow-200 text-center mb-6">
                    <h3 class="text-2xl md:text-3xl font-bold text-yellow-700">${CONTENT[appState.module].title[appState.language]} Quiz</h3>
                </div>

                <div class="text-center p-8 bg-white rounded-2xl shadow-lg border-2 border-yellow-500">
                    <p class="text-2xl md:text-3xl font-semibold text-gray-700 mb-8">${t('quiz_question')} <span class="font-extrabold text-yellow-800">${question}</span></p>
                    
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Options will be added here by JS -->
                    </div>

                    <div id="quiz-message" class="mt-8 text-center text-3xl font-bold"></div>
                </div>
            `;
            
            const optionsContainer = document.getElementById('quiz-options');
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = 'large-touch-target bg-indigo-100 hover:bg-indigo-200 active:bg-indigo-300 text-indigo-800 shadow-md';
                button.onclick = () => handleQuizSelection(option.correct);
                optionsContainer.appendChild(button);
            });
        }

        function renderManagementView() {
            const learnerListEl = document.getElementById('learner-list');
            
            // Clear the list first
            learnerListEl.innerHTML = '';
            
            if (appState.learnerData.length === 0) {
                learnerListEl.innerHTML = `
                    <p class="text-center text-gray-500 italic p-4">${appState.authReady ? 'No learners registered yet.' : 'Loading learners...'}</p>
                `;
            } else {
                appState.learnerData.forEach(learner => {
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between p-4 mb-2 bg-gray-50 border border-gray-200 rounded-lg shadow-sm';
                    
                    listItem.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold text-indigo-800">${learner.firstName} ${learner.lastName}</p>
                            <p class="text-sm text-gray-600">Grade: ${learner.grade}</p>
                            <p class="text-xs text-gray-500">ID: <span class="font-mono bg-gray-200 px-1 rounded">${learner.id.substring(0, 8)}...</span></p>
                        </div>
                        <button onclick="deleteLearner('${learner.id}')" class="text-red-500 hover:text-red-700 large-touch-target p-2 bg-white rounded-full transition-colors duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                            <span class="sr-only">${t('delete')}</span>
                        </button>
                    `;
                    learnerListEl.appendChild(listItem);
                });
            }
        }

        // The settings view content is largely static HTML, but we will ensure form elements are populated.
        function renderSettingsView() {
            // Update the form controls based on appState
            document.getElementById('module-select').value = appState.module;
            document.getElementById('language-select').value = appState.language;
            document.getElementById('contrast-select').value = appState.contrastMode;
            document.getElementById('text-size-select').value = appState.textSize;
            document.getElementById('voice-rate').value = appState.voiceRate || 0.6;
            document.getElementById('voice-pitch').value = appState.voicePitch || 1.0;
            // The voice-select is handled by populateVoiceSelect() after TTS init
        }


        // --- State/Navigation Logic ---

        function changeView(newView) {
            const views = ['lesson-view', 'quiz-view', 'management-view', 'settings-view'];
            views.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (viewId === `${newView}-view`) {
                    view.classList.remove('hidden');
                    appState.currentView = newView;
                    // Re-render content specific to the new view
                    if (newView === 'lesson') renderLessonView();
                    if (newView === 'quiz') renderQuizView();
                    if (newView === 'management') renderManagementView();
                    if (newView === 'settings') renderSettingsView();
                } else {
                    view.classList.add('hidden');
                }
            });

            // Update active state of nav buttons
            const navButtons = document.querySelectorAll('#nav-bar button');
            navButtons.forEach(button => {
                if (button.dataset.view === newView) {
                    button.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                    button.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
                } else {
                    button.classList.remove('bg-indigo-500', 'text-white', 'shadow-md');
                    button.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                }
            });
        }

        function loadModule(moduleName) {
            appState.module = moduleName;
            
            // Reset index based on module
            if (moduleName === 'literacy') {
                // If index doesn't exist, set to 0
                appState.currentLiteracyIndex = appState.currentLiteracyIndex || 0;
            } else if (moduleName === 'numeracy') {
                appState.currentNumeracyIndex = appState.currentNumeracyIndex || 0;
            } else if (moduleName === 'life_skills') {
                appState.currentLifeSkillsIndex = appState.currentLifeSkillsIndex || 0;
            }

            // Re-render the current view to show new module content
            if (appState.currentView === 'lesson') renderLessonView();
            if (appState.currentView === 'quiz') renderQuizView();
        }

        function setLanguage(lang) {
            appState.language = lang;
            // Full re-render needed to update all text elements
            updateAllText();
            // Re-render current view content
            if (appState.currentView === 'lesson') renderLessonView();
            if (appState.currentView === 'quiz') renderQuizView();
        }

        function navigateLesson(direction) {
            let currentIndexKey = `current${appState.module.charAt(0).toUpperCase() + appState.module.slice(1)}Index`;
            const totalItems = CONTENT[appState.module].items.length;
            
            if (direction === 'next' && appState[currentIndexKey] < totalItems - 1) {
                appState[currentIndexKey]++;
            } else if (direction === 'prev' && appState[currentIndexKey] > 0) {
                appState[currentIndexKey]--;
            }
            renderLessonView();
        }

        function handleQuizSelection(isCorrect) {
            const quizMessage = document.getElementById('quiz-message');
            if (isCorrect) {
                showFeedback(t('correct'), 'success');
                // Auto-advance to the next lesson item after correct answer
                setTimeout(() => navigateLesson('next'), 2000);
            } else {
                showFeedback(t('incorrect'), 'error');
            }
        }

        function showFeedback(message, type) {
            const quizMessage = document.getElementById('quiz-message');
            quizMessage.textContent = message;
            
            if (type === 'success') {
                quizMessage.className = 'mt-8 text-center text-3xl font-bold text-green-600';
            } else if (type === 'error') {
                quizMessage.className = 'mt-8 text-center text-3xl font-bold text-red-600';
            } else { // info
                quizMessage.className = 'mt-8 text-center text-3xl font-bold text-blue-600';
            }

            // Clear message after 3 seconds, but not if it's a success/error state to allow user to see it
            if (type !== 'success' && type !== 'error') {
                setTimeout(() => {
                    quizMessage.textContent = '';
                    quizMessage.className = 'mt-8 text-center text-xl font-bold';
                }, 3000);
            }
        }

        function applyTheme(mode) {
            appState.contrastMode = mode;
            const body = document.getElementById('app-body');
            const navBar = document.getElementById('nav-bar');
            
            if (mode === 'high_contrast') {
                body.className = 'bg-black text-yellow-300 min-h-screen';
                navBar.classList.remove('bg-white');
                navBar.classList.add('bg-gray-900');
            } else { // normal
                body.className = 'bg-gray-50 text-gray-900 min-h-screen';
                navBar.classList.remove('bg-gray-900');
                navBar.classList.add('bg-white');
            }
            // Re-render all views to update color changes on internal elements
            updateAllText();
            changeView(appState.currentView);
        }

        function applyTextSize(size) {
            appState.textSize = size;
            // The font size logic is handled directly in renderLessonView() now
            if (appState.currentView === 'lesson') renderLessonView();
        }

        function updateAllText() {
            // Update navigation text
            document.getElementById('nav-lesson').textContent = t('nav').lesson;
            document.getElementById('nav-quiz').textContent = t('nav').quiz;
            document.getElementById('nav-management').textContent = t('nav').management;
            document.getElementById('nav-settings').textContent = t('nav').settings;
            // The rest of the text is updated by re-rendering the current view, but we can update static text here
            document.getElementById('module-literacy-label').textContent = t('literacy_module');
            document.getElementById('module-numeracy-label').textContent = t('numeracy_module');
            document.getElementById('module-life_skills-label').textContent = t('life_skills_module');
        }

        // --- Firebase/Firestore Logic ---
        
        async function firebaseInit() {
            try {
                // Import necessary modules
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                const { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const { setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                if (!firebaseConfig) {
                    throw new Error("Firebase configuration is missing.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('debug'); // Enable for debugging
                
                // 1. Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        appState.authReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        
                        // Start listening to Learner Data and Settings
                        setupLearnerListener();
                    } else {
                        console.log("No user signed in (using anonymous fallback).");
                    }
                });

            } catch (error) {
                console.error("FIREBASE INIT ERROR:", error);
                document.getElementById('learner-form-message').textContent = "Database Offline: Management features disabled.";
            }
        }

        function getLearnersCollectionPath() {
            // Private Data Path: /artifacts/{appId}/users/{userId}/learners
            return `/artifacts/${appId}/users/${userId}/learners`;
        }

        function setupLearnerListener() {
            if (!db || !userId) return;
            const learnerColRef = collection(db, getLearnersCollectionPath());
            const q = query(learnerColRef);

            onSnapshot(q, (snapshot) => {
                const learners = [];
                snapshot.forEach((doc) => {
                    learners.push({ id: doc.id, ...doc.data() });
                });
                appState.learnerData = learners;
                console.log("Learner data updated:", learners.length, "learners.");
                
                // Only re-render management view if it's the current view
                if (appState.currentView === 'management') {
                    renderManagementView();
                }
            }, (error) => {
                console.error("Learner snapshot listener failed:", error);
            });
        }

        async function registerLearner(event) {
            event.preventDefault();
            if (!db || !userId) {
                showFormFeedback("Database not ready or User not authenticated.", 'error');
                return;
            }

            const form = event.target;
            const firstName = form.elements['first-name'].value.trim();
            const lastName = form.elements['last-name'].value.trim();
            const grade = parseInt(form.elements['grade-level'].value);
            const uniqueId = form.elements['unique-id'].value.trim();

            if (!firstName || !lastName || !grade) {
                showFormFeedback("Please fill in First Name, Last Name, and Grade Level.", 'error');
                return;
            }

            const newLearner = {
                firstName: firstName,
                lastName: lastName,
                grade: grade,
                uniqueId: uniqueId || null,
                registeredAt: new Date().toISOString()
            };

            try {
                const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const docRef = await addDoc(collection(db, getLearnersCollectionPath()), newLearner);
                showFormFeedback(`âœ… Learner successfully registered! ID: ${docRef.id.substring(0, 5)}...`, 'success');
                document.getElementById('add-learner-form').reset();
            } catch (error) {
                console.error("Error adding new learner:", error);
                showFormFeedback("âŒ Failed to register learner. Check console for details.", 'error');
            }
        }

        async function deleteLearner(learnerId) {
            if (!db || !userId || !confirm(`Are you sure you want to delete this learner (ID: ${learnerId.substring(0, 5)}...)?`)) {
                return;
            }
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const docRef = doc(db, getLearnersCollectionPath(), learnerId);
                await deleteDoc(docRef);
                showFormFeedback(`ðŸ—‘ï¸ Learner deleted!`, 'info');
            } catch (error) {
                console.error("Error deleting learner:", error);
                showFormFeedback("âŒ Failed to delete learner. Check console for details.", 'error');
            }
        }

        function showFormFeedback(message, type) {
            const formMessageEl = document.getElementById('learner-form-message');
            formMessageEl.textContent = message;
            
            if (type === 'success') {
                formMessageEl.className = 'mt-4 text-center font-semibold text-green-600';
            } else if (type === 'error') {
                formMessageEl.className = 'mt-4 text-center font-semibold text-red-600';
            } else { // info
                formMessageEl.className = 'mt-4 text-center font-semibold text-blue-600';
            }

            setTimeout(() => {
                formMessageEl.textContent = '';
                formMessageEl.className = 'mt-4 text-center font-semibold';
            }, 5000);
        }

        // --- Event Listener Setup ---

        // Handle settings form changes (not using a submit button, changes apply immediately)
        function handleSettingsChange(event) {
            const { id, value } = event.target;
            if (id === 'module-select') loadModule(value);
            if (id === 'language-select') setLanguage(value);
            if (id === 'contrast-select') applyTheme(value);
            if (id === 'text-size-select') applyTextSize(value);
            
            // TTS Settings (update state for the speaker function)
            if (id === 'voice-select') appState.voiceName = value;
            if (id === 'voice-rate') appState.voiceRate = parseFloat(value);
            if (id === 'voice-pitch') appState.voicePitch = parseFloat(value);
        }
        
        // Initial setup on load
        window.onload = function() {
            initializeTTS();
            firebaseInit(); 
            
            // Apply initial accessibility state
            applyTheme(appState.contrastMode);
            applyTextSize(appState.textSize);
            
            // Load the default module (Literacy)
            loadModule(appState.module); 
            
            // Set default language after loading content
            setLanguage(appState.language);
            
            // Default to Lesson View and render it
            changeView('lesson');

            // Attach form event listener after DOM is ready
            document.getElementById('add-learner-form').addEventListener('submit', registerLearner);
            document.getElementById('settings-form').addEventListener('change', handleSettingsChange);

            console.log("Meqenet Learner App initialized.");
        };

    </script>
</head>

<!-- Main container for the whole application -->
<body id="app-body" class="bg-gray-50 text-gray-900 min-h-screen">

    <div id="main-container" class="min-h-screen flex flex-col max-w-7xl mx-auto bg-white shadow-2xl">

        <!-- Header -->
        <header id="header" class="p-4 bg-indigo-700 text-white shadow-lg sticky top-0 z-10">
            <h1 class="text-3xl font-extrabold text-center">Meqenet Learner App</h1>
            <p class="text-center text-indigo-200 text-sm">Interactive Education for All</p>
        </header>

        <!-- Navigation Bar -->
        <nav id="nav-bar" class="p-2 shadow-inner bg-white sticky top-16 z-10">
            <div class="flex justify-around space-x-2">
                <button id="nav-lesson" data-view="lesson" onclick="changeView('lesson')" class="large-touch-target flex-1 text-sm bg-indigo-500 text-white shadow-md">Lesson</button>
                <button id="nav-quiz" data-view="quiz" onclick="changeView('quiz')" class="large-touch-target flex-1 text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Quiz</button>
                <button id="nav-management" data-view="management" onclick="changeView('management')" class="large-touch-target flex-1 text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Learner Management</button>
                <button id="nav-settings" data-view="settings" onclick="changeView('settings')" class="large-touch-target flex-1 text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Settings</button>
            </div>
        </nav>

        <!-- Main Content Area - Uses flex-grow to take up vertical space -->
        <main id="content-area" class="flex-grow p-4 md:p-8">
            
            <!-- Lesson View -->
            <div id="lesson-view" class="space-y-6">
                <!-- Content is rendered by renderLessonView() -->
            </div>

            <!-- Quiz View -->
            <div id="quiz-view" class="hidden space-y-6">
                <!-- Content is rendered by renderQuizView() -->
            </div>

            <!-- Learner Management View - Improved Responsive Layout -->
            <div id="management-view" class="hidden">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-8 border-b pb-3">Learner Management Portal</h2>
                
                <!-- Responsive Grid: Two columns on large screens, stacked on mobile -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Column 1: Add New Learner -->
                    <div id="add-learner-section" class="section-card bg-indigo-50 border border-indigo-200 h-full">
                        <h3 class="text-2xl font-bold text-indigo-800 mb-6">${t('register_learner')}</h3>
                        <form id="add-learner-form" class="space-y-4">
                            <div>
                                <label for="first-name" class="block text-sm font-medium text-gray-700">${t('first_name')}</label>
                                <input type="text" id="first-name" name="first-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                            </div>
                            <div>
                                <label for="last-name" class="block text-sm font-medium text-gray-700">${t('last_name')}</label>
                                <input type="text" id="last-name" name="last-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="grade-level" class="block text-sm font-medium text-gray-700">${t('grade')}</label>
                                    <input type="number" id="grade-level" name="grade-level" required min="1" max="8" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                </div>
                                <div>
                                    <label for="unique-id" class="block text-sm font-medium text-gray-700">${t('learner_id')}</label>
                                    <input type="text" id="unique-id" name="unique-id" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border" placeholder="Optional">
                                </div>
                            </div>
                            
                            <button type="submit" class="large-touch-target w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                ${t('submit')}
                            </button>
                            <div id="learner-form-message" class="mt-4 text-center font-semibold"></div>
                        </form>
                    </div>
                    
                    <!-- Column 2: Current Learners List -->
                    <div id="learners-list-section" class="section-card bg-white border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">${t('current_learners')}</h3>
                        <div id="learner-list" class="space-y-3">
                            <p class="text-center text-gray-500 italic p-4">Loading learners...</p>
                            <!-- Learner list populated by onSnapshot listener -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <h2 class="text-3xl font-extrabold text-indigo-700 mb-8 border-b pb-3">Settings & Preferences</h2>
                <form id="settings-form" class="space-y-8">

                    <!-- Module & Language Section -->
                    <div class="section-card bg-blue-50 border border-blue-200">
                        <h3 class="text-xl font-semibold text-blue-700 mb-4">Content Preferences</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Module Selector -->
                            <div>
                                <label for="module-select" class="block text-sm font-medium text-gray-700">Module</label>
                                <select id="module-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                    <option value="literacy" id="module-literacy-label">Literacy Module</option>
                                    <option value="numeracy" id="module-numeracy-label">Numeracy Module</option>
                                    <option value="life_skills" id="module-life_skills-label">Life Skills Module</option>
                                </select>
                            </div>
                            <!-- Language Selector -->
                            <div>
                                <label for="language-select" class="block text-sm font-medium text-gray-700">Display Language</label>
                                <select id="language-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                    <option value="english">English</option>
                                    <option value="amharic">Amharic (áŠ áˆ›áˆ­áŠ›)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Accessibility Section -->
                    <div class="section-card bg-yellow-50 border border-yellow-200">
                        <h3 class="text-xl font-semibold text-yellow-700 mb-4">${t('accessibility')}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Contrast Mode -->
                            <div>
                                <label for="contrast-select" class="block text-sm font-medium text-gray-700">${t('contrast')}</label>
                                <select id="contrast-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                    <option value="normal">${t('normal')}</option>
                                    <option value="high_contrast">${t('high_contrast')}</option>
                                </select>
                            </div>
                            <!-- Text Size -->
                            <div>
                                <label for="text-size-select" class="block text-sm font-medium text-gray-700">${t('text_size')}</label>
                                <select id="text-size-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                    <option value="small">${t('small')}</option>
                                    <option value="medium">${t('medium')}</option>
                                    <option value="large">${t('large')}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TTS Voice Settings Section -->
                    <div class="section-card bg-green-50 border border-green-200">
                        <h3 class="text-xl font-semibold text-green-700 mb-4">${t('voice_settings')}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Voice Select -->
                            <div>
                                <label for="voice-select" class="block text-sm font-medium text-gray-700">${t('select_voice')}</label>
                                <select id="voice-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                                    <option value="">Loading Voices...</option>
                                </select>
                            </div>
                            <!-- Rate Slider -->
                            <div>
                                <label for="voice-rate" class="block text-sm font-medium text-gray-700">${t('rate')} (<span id="rate-value">0.6</span>)</label>
                                <input type="range" id="voice-rate" min="0.1" max="2.0" step="0.1" value="0.6" class="mt-3 w-full" oninput="document.getElementById('rate-value').textContent=this.value">
                            </div>
                            <!-- Pitch Slider -->
                            <div>
                                <label for="voice-pitch" class="block text-sm font-medium text-gray-700">${t('pitch')} (<span id="pitch-value">1.0</span>)</label>
                                <input type="range" id="voice-pitch" min="0.1" max="2.0" step="0.1" value="1.0" class="mt-3 w-full" oninput="document.getElementById('pitch-value').textContent=this.value">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

        </main>
        
        <!-- Footer -->
        <footer class="p-2 text-center text-xs text-gray-400 border-t mt-4">
            Meqenet Learner App Demo | Designed for Accessibility
        </footer>
    </div>
</body>
</html>
